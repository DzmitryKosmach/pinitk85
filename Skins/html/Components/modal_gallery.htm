<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–∞–ª–µ—Ä–µ–∏ -->
<div id="gallery-modal" class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300 hidden">
  <!-- –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div class="relative max-w-full max-h-[90vh] flex items-center justify-center">
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫) -->
    <div class="relative inline-block max-w-full max-h-[90vh]">
      <img
        id="gallery-main-img"
        src=""
        alt=""
        class="max-w-full max-h-[90vh] object-contain rounded-xl shadow-2xl"
      />

      <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è (–≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è) -->
      <button
        id="gallery-close"
        class="absolute top-2 right-2 text-white/90 hover:text-white text-lg font-light z-51 bg-black/40 backdrop-blur-sm rounded-full w-8 h-8 flex items-center justify-center transition-all duration-200 ease-in-out"
        aria-label="–ó–∞–∫—Ä—ã—Ç—å"
      >
        ‚úï
      </button>

      <!-- –°—Ç—Ä–µ–ª–∫–∞ "–Ω–∞–∑–∞–¥" -->
      <button
        id="gallery-prev"
        class="absolute left-2 top-1/2 -translate-y-1/2 text-white/90 hover:text-white text-3xl z-51 bg-black/40 backdrop-blur-sm rounded-full w-12 h-12 flex items-center justify-center transition-all duration-200 ease-in-out hover:scale-110"
        aria-label="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
      >
        <
      </button>

      <!-- –°—Ç—Ä–µ–ª–∫–∞ "–≤–ø–µ—Ä—ë–¥" -->
      <button
        id="gallery-next"
        class="absolute right-2 top-1/2 -translate-y-1/2 text-white/90 hover:text-white text-3xl z-51 bg-black/40 backdrop-blur-sm rounded-full w-12 h-12 flex items-center justify-center transition-all duration-200 ease-in-out hover:scale-110"
        aria-label="–°–ª–µ–¥—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
      >
        >
      </button>
    </div>
  </div>

  <!-- –°—á—ë—Ç—á–∏–∫ (–ø–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º, –ø–æ —Ü–µ–Ω—Ç—Ä—É) -->
  <div id="gallery-counter" class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white/70 text-base font-mono tracking-wide bg-black/20 px-3 py-1 rounded-full backdrop-blur-sm"></div>
</div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // === –ì–ê–õ–ï–†–ï–Ø: –¥–∞–Ω–Ω—ã–µ ===
        const photos = <?php echo json_encode(array_map(function($p) use ($catInf, $seriesInf) {
          return [
            'src' => Catalog::photoUrl(Catalog_Series_Photos::$imagePath, $p['id'], 0, 0, 0, $p['_img_ext'], [$catInf['url'], $seriesInf['url']]),
            'thumb' => Catalog::photoUrl(Catalog_Series_Photos::$imagePath, $p['id'], 90, 90, $p['rm'], $p['_img_ext']),
            'alt' => hsch(trim($p['alt']) ? $p['alt'] : $catInf['name'] . ' ' . $seriesInf['name'])
        ];
        }, $photos)); ?>;

        let currentGalleryIndex = 0;

        // === –≠–ª–µ–º–µ–Ω—Ç—ã DOM ===
        const mainImage = document.getElementById('main-product-image');
        const mainImageContainer = document.getElementById('mainImageContainer');
        const galleryModal = document.getElementById('gallery-modal');
        const galleryImg = document.getElementById('gallery-main-img');
        const galleryClose = document.getElementById('gallery-close');
        const galleryPrev = document.getElementById('gallery-prev');
        const galleryNext = document.getElementById('gallery-next');
        const galleryCounter = document.getElementById('gallery-counter');

        // === –û—Ç–∫—Ä—ã—Ç–∏–µ –≥–∞–ª–µ—Ä–µ–∏ ===
        mainImageContainer.addEventListener('click', () => {
          currentGalleryIndex = 0; // –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          updateGalleryImage();
          galleryModal.classList.remove('hidden', 'pointer-events-none');
          setTimeout(() => galleryModal.classList.add('opacity-100', 'pointer-events-auto'), 10);
        });

        // === –ó–∞–∫—Ä—ã—Ç–∏–µ –≥–∞–ª–µ—Ä–µ–∏ ===
        function closeGallery() {
          galleryModal.classList.remove('opacity-100', 'pointer-events-auto');
          setTimeout(() => galleryModal.classList.add('hidden', 'pointer-events-none'), 300);
        }

        galleryClose.addEventListener('click', closeGallery);
        galleryModal.addEventListener('click', (e) => {
          if (e.target === galleryModal) closeGallery();
        });

        // === –ù–∞–≤–∏–≥–∞—Ü–∏—è ===
        galleryPrev.addEventListener('click', () => {
          currentGalleryIndex = (currentGalleryIndex - 1 + photos.length) % photos.length;
          updateGalleryImage();
        });

        galleryNext.addEventListener('click', () => {
          currentGalleryIndex = (currentGalleryIndex + 1) % photos.length;
          updateGalleryImage();
        });

        // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –≥–∞–ª–µ—Ä–µ–µ ===
        function updateGalleryImage() {
          const photo = photos[currentGalleryIndex];
          galleryImg.src = photo.src;
          galleryImg.alt = photo.alt;
          if (galleryCounter) {
            galleryCounter.textContent = `${currentGalleryIndex + 1} / ${photos.length}`;
          }
        }

        // === –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ ===
        window.addEventListener('keydown', (e) => {
          if (!galleryModal.classList.contains('opacity-100')) return;

          if (e.key === 'Escape') closeGallery();
          else if (e.key === 'ArrowLeft') galleryPrev.click();
          else if (e.key === 'ArrowRight') galleryNext.click();
        });

        // === –°–º–µ–Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∏–Ω–∏–∞—Ç—é—Ä—ã) ===
        const infoDots = document.getElementById('infoDots');

        function changeMainImage(thumb) {
          const bigImage = thumb.dataset.bigimage;
          const alt = thumb.alt;

          if (!mainImage || !bigImage) return;

          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –º–∏–Ω–∏–∞—Ç—é—Ä
          document.querySelectorAll('.slider-track img').forEach(img => {
            img.style.borderColor = ''; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–ª–∞–π–Ω–æ–≤—ã–π —Ü–≤–µ—Ç
          });
          thumb.style.setProperty('border-color', '#2563eb', 'important');

          // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∞–º–∏
          const thumbIndex = Array.from(document.querySelectorAll('.slider-track img')).indexOf(thumb);
          if (infoDots) {
            infoDots.classList.toggle('hidden', thumbIndex !== 0);
          }

          // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –≤—ã—Å–æ—Ç—ã
          mainImage.onload = () => {
            mainImage.onload = null; // –æ—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è
            requestAnimationFrame(refreshSlider);
          };

          // –ú–µ–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          mainImage.src = bigImage;
          mainImage.alt = alt;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä
        const firstThumb = document.querySelector('.slider-track img');
        if (firstThumb) changeMainImage(firstThumb);

        document.querySelectorAll('.slider-track img').forEach(img => {
          img.addEventListener('click', () => changeMainImage(img));
        });

        // === –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–ª–∞–π–¥–µ—Ä–∞ –º–∏–Ω–∏–∞—Ç—é—Ä (–æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∞—à—É –ª–æ–≥–∏–∫—É) ===
        function updateThumbnailSliderHeight() {
          const track = document.querySelector('.slider-track');
          const container = document.querySelector(".slider-thumbnails-container > .relative");

          // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç ‚Äî –≤—ã—Ö–æ–¥–∏–º
          if (!track || !container) return;

          if (window.innerWidth < 1024) {
            // === –ú–æ–±–∏–ª—å–Ω—ã–π —Ä–µ–∂–∏–º: —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –í–°–Å (—à–∏—Ä–∏–Ω–∞ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É –∏–ª–∏ 100%) ===
            track.style.height = '';
            track.style.maxHeight = '';
            track.style.width = '';
            track.style.minWidth = '';
            track.style.maxWidth = '';

            container.style.height = '';
            container.style.maxHeight = '';
            container.style.width = '';
            container.style.minWidth = '';
            container.style.maxWidth = '';

            return;
          }


          // === –î–µ—Å–∫—Ç–æ–ø–Ω—ã–π —Ä–µ–∂–∏–º (>=1024px) ===
          const mainImageEl = document.querySelector('#mainImageContainer > img');
          if (!mainImageEl) return;

          const imageHeight = mainImageEl.getBoundingClientRect().height;
          if (imageHeight <= 0) return;

          // const btnHeight = 20; // –≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–æ–∫ "–≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑"
          // const gap = 16;       // —Å—É–º–º–∞—Ä–Ω—ã–π gap –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ –∏ —Ç—Ä–µ–∫–æ–º
          // const desiredTrackHeight = imageHeight - btnHeight * 2 - gap;
          const desiredTrackHeight = imageHeight - btnHeight * 2 - gap;
          const finalTrackHeight = desiredTrackHeight > 100 ? desiredTrackHeight : 400;

          // --- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –¢–†–ï–ö–ê (—Å–ª–∞–π–¥–µ—Ä –º–∏–Ω–∏–∞—Ç—é—Ä) ---
          // track.style.height = finalTrackHeight + 'px';
          // track.style.maxHeight = finalTrackHeight + 'px';
          // track.style.width = '80px';      // üî• —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞
          // track.style.minWidth = '80px';   // üî• –Ω–µ –¥–∞—ë–º —Å–∂–∞—Ç—å—Å—è –º–µ–Ω—å—à–µ
          // track.style.maxWidth = '80px';   // üî• –∏ –Ω–µ —Ä–∞—Å—à–∏—Ä–∏—Ç—å—Å—è –±–æ–ª—å—à–µ

          // --- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ö–û–ù–¢–ï–ô–ù–ï–†–ê (–æ–±—ë—Ä—Ç–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏) ---
          container.style.height = imageHeight + 'px';
          container.style.maxHeight = imageHeight + 'px';
          container.style.width = '80px';
          container.style.minWidth = '80px';
          container.style.maxWidth = '80px';
        }

        function refreshSlider() {
          updateThumbnailSliderHeight();
          // fitToFullSlides();
        }

        window.addEventListener('load', refreshSlider);
        window.addEventListener('resize', refreshSlider);
        mainImage?.addEventListener('load', refreshSlider);
      });
    </script>
