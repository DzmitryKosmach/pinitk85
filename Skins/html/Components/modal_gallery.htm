<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–∞–ª–µ—Ä–µ–∏ -->
<div id="gallery-modal"
     class="fixed inset-0 bg-black bg-opacity-90 z-[999] items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300 hidden">
  <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å –º–∏–Ω–∏–∞—Ç—é—Ä (–¥–µ—Å–∫—Ç–æ–ø) -->
  <div id="gallery-thumbnails-desktop"
       class="hidden lg:block absolute left-4 top-4 bottom-4 w-20 flex flex-col items-center py-2 space-y-2 overflow-y-auto overflow-x-hidden z-[60]">
    <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
  </div>

  <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –º–∏–Ω–∏–∞—Ç—é—Ä (–º–æ–±–∏–ª—å–Ω—ã–µ) -->
  <div id="gallery-thumbnails-mobile"
       class="lg:hidden absolute bottom-4 left-4 right-4 h-20 flex items-center overflow-x-auto overflow-y-hidden py-2 space-x-2 z-[60] scrollbar-none">
    <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
  </div>

  <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
  <div id="gallery-image-container"
       class="relative h-full flex items-center justify-center rounded-xl overflow-hidden transition-all duration-300 ease-out lg:ml-24 mb-8 lg:mb-0">
    <img id="gallery-main-img" src="" alt=""
         class="max-w-full max-h-[calc(90vh-2rem)] lg:max-h-[90vh] object-contain shadow-2xl transition-transform duration-300 ease-out cursor-zoom-in" />
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
  <button id="gallery-close"
          class="absolute top-4 right-4 w-10 h-10 flex items-center justify-center text-5xl text-white/90 z-[61] bg-red/40 backdrop-blur-sm rounded-full transition-all duration-200 ease-in-out hover:text-white hover:bg-red-600"
          aria-label="–ó–∞–∫—Ä—ã—Ç—å –≥–∞–ª–µ—Ä–µ—é">
    √ó
  </button>

  <!-- –°—Ç—Ä–µ–ª–∫–∞ "–Ω–∞–∑–∞–¥" -->
  <button
    id="gallery-prev"
    class="absolute lg:left-28 left-4 top-[calc(50%-2.2rem)] -translate-y-1/2 z-[61] p-2 rounded-full  hover:backdrop-blur-sm text-blue-600 transition-all duration-200 ease-in-out hover:scale-110 focus:outline-none focus:ring-0"
    aria-label="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-10 w-10"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
    </svg>
  </button>

  <!-- –°—Ç—Ä–µ–ª–∫–∞ "–≤–ø–µ—Ä—ë–¥" -->
  <button id="gallery-next"
          class="absolute right-4 top-[calc(50%-2.2rem)] -translate-y-1/2 z-[61] p-2 rounded-full  hover:backdrop-blur-sm text-blue-600 transition-all duration-200 ease-in-out hover:scale-110 focus:outline-none focus:ring-0"
          aria-label="–°–ª–µ–¥—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"
         stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
    </svg>
  </button>

  <!-- –°—á—ë—Ç—á–∏–∫ -->
  <div id="gallery-counter"
       class="absolute lg:bottom-4 bottom-28 left-1/2 -translate-x-1/2 text-white/80 text-sm font-mono tracking-wide bg-black/30 px-3 py-1.5 rounded-full backdrop-blur-sm z-[62]">
  </div>

  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –º–∞—Å—à—Ç–∞–±–∞ + –∏–∫–æ–Ω–∫–∞ –ª—É–ø—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö) -->
  <div id="gallery-zoom-indicator"
       class="absolute top-4 lg:left-28 left-4 text-white/80 text-sm font-mono tracking-wide bg-black/30 px-3 py-1.5 rounded-full backdrop-blur-sm hidden z-[62] flex items-center gap-1">
    <svg id="gallery-zoom-icon"
         xmlns="http://www.w3.org/2000/svg"
         class="h-8 w-8 cursor-pointer transition-transform duration-200 ease-in-out hover:scale-110"
         fill="none"
         viewBox="0 0 24 24"
         stroke="currentColor"
         stroke-width="2">
      <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </svg>
    <span id="gallery-zoom-text">100%</span>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –∑—É–º–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö) -->
  <button id="gallery-reset-zoom"
          class="lg:hidden absolute bottom-24 right-4 text-white/90 text-sm font-light z-[61] bg-black/60 backdrop-blur-sm rounded-full w-10 h-10 flex items-center justify-center transition-all duration-200 ease-in-out hover:bg-black/80 hidden"
          aria-label="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
         stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7" />
    </svg>
  </button>
</div>

<?php
$photosUnified = [];

// --- –ï—Å–ª–∏ —ç—Ç–æ –§–û–¢–û –¢–û–í–ê–†–ê (–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç rm) ---
if (isset($photos[0]['rm'])) {

    foreach ($photos as $p) {
        $photosUnified[] = [
            'src'   => Catalog::photoUrl(
Catalog_Series_Photos::$imagePath,
$p['id'], 0, 0, 0, $p['_img_ext'],
[$catInf['url'], $seriesInf['url']]
),
'thumb' => Catalog::photoUrl(
Catalog_Series_Photos::$imagePath,
$p['id'], 90, 90, $p['rm'], $p['_img_ext']
),
'alt'   => hsch(
trim($p['alt'])
? $p['alt']
: $catInf['name'] . ' ' . $seriesInf['name']
),
'highslide' => false
];
}
}

// --- –ï—Å–ª–∏ —ç—Ç–æ –§–û–¢–û –ü–†–û–ï–ö–¢–ê ---
else {


foreach ($photos as $i => $p) {

// –±–æ–ª—å—à–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
$src = Config::pathRel('images') .
Clients_Projects_Pics::$imagePath .
$p['id'] . '_0x0_1.' . $p['_img_ext'];

// –º–∏–Ω–∏–∞—Ç—é—Ä—ã 90x90
$thumb = Config::pathRel('images') .
Clients_Projects_Pics::$imagePath .
$p['id'] . '_90x90_0.' .
$p['_img_ext'];

$photosUnified[] = [
'src'       => $src,
'thumb'     => $thumb,
'alt'       => hsch($p['alt']),
'highslide' => true
];
}
}
?>

<style>
  /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
  .scrollbar-none {
    -ms-overflow-style: none;
    /* IE –∏ Edge */
    scrollbar-width: none;
    /* Firefox */
  }

  .scrollbar-none::-webkit-scrollbar {
    display: none;
    /* Chrome, Safari –∏ Opera */
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö –º–∏–Ω–∏–∞—Ç—é—Ä */
  #gallery-thumbnails-desktop {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  #gallery-thumbnails-desktop::-webkit-scrollbar {
    display: none;
  }

  /* –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä */
  #gallery-thumbnails-desktop,
  #gallery-thumbnails-mobile {
    scroll-behavior: smooth;
  }

  /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω–∏–∞—Ç—é—Ä */
  #gallery-thumbnails-desktop {
    height: calc(100vh - 5rem);
    /* –û—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
  }

  #gallery-thumbnails-mobile {
    min-height: 5rem;
    /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
  }

  /* –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä */
  #gallery-thumbnails-desktop img,
  #gallery-thumbnails-mobile img {
    aspect-ratio: 1;
    object-fit: cover;
  }

  /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä */
  #gallery-thumbnails-desktop div,
  #gallery-thumbnails-mobile div {
    transition: transform 0.2s ease, border-color 0.2s ease;
  }

  /* –ê–∫—Ç–∏–≤–Ω–∞—è –º–∏–Ω–∏–∞—Ç—é—Ä–∞ */
  #gallery-thumbnails-desktop div.active,
  #gallery-thumbnails-mobile div.active {
    transform: scale(0.95);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  #gallery-thumbnails-desktop {
    scrollbar-width: none;
    /* Firefox */
    -ms-overflow-style: none;
    /* IE –∏ Edge */
  }

  #gallery-thumbnails-desktop::-webkit-scrollbar {
    display: none;
    /* Chrome, Safari –∏ Opera */
  }

  #gallery-thumbnails-desktop {
    scroll-behavior: smooth;
    overflow-y: auto;
    overflow-x: hidden;
  }
</style>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    // === –ì–ê–õ–ï–†–ï–Ø: –¥–∞–Ω–Ω—ã–µ ===

    const photos = <?= json_encode($photosUnified, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES) ?>;

    let currentGalleryIndex = 0;
    let isZoomed = false;
    let isDragging = false; // —Ç–æ–ª—å–∫–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
    let startX, startY;
    let translateX = 0, translateY = 0;
    let currentScale = 1;
    let isDesktopZoomMode = false;
    let currentMainIndex = 0;
    let autoResetZoomTimer = null;
    let lastInteractionTime = Date.now();
    let touchStartX = 0;
    let touchEndX = 0;
    const SWIPE_THRESHOLD = 50; // –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ —Å–≤–∞–π–ø–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö

    // === –ù–ê–°–¢–†–û–ô–ö–ò –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–Ø ===
    const MIN_ZOOM = 1.2;
    const MAX_ZOOM = 2.0;
    const ZOOM_STEP = 0.1;
    const MOBILE_AUTO_RESET_DELAY = 3000; // 3 —Å–µ–∫—É–Ω–¥—ã –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è

    // === –≠–ª–µ–º–µ–Ω—Ç—ã DOM ===
    const mainImage = document.getElementById('main-product-image');
    const mainImageContainer = document.getElementById('mainImageContainer');
    const galleryModal = document.getElementById('gallery-modal');
    const galleryImg = document.getElementById('gallery-main-img');
    const galleryImageContainer = document.getElementById('gallery-image-container');
    const galleryClose = document.getElementById('gallery-close');
    const galleryPrev = document.getElementById('gallery-prev');
    const galleryNext = document.getElementById('gallery-next');
    const galleryCounter = document.getElementById('gallery-counter');
    const galleryZoomIndicator = document.getElementById('gallery-zoom-indicator');
    const galleryResetZoom = document.getElementById('gallery-reset-zoom');
    const galleryThumbnailsDesktop = document.getElementById('gallery-thumbnails-desktop');
    const galleryThumbnailsMobile = document.getElementById('gallery-thumbnails-mobile');

    // === –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –≤–∏–¥–∏–º—ã—Ö –º–∏–Ω–∏–∞—Ç—é—Ä ===
    function calculateVisibleThumbnails(container, isMobile = false) {
      if (!container || !container.children.length) return 1;

      const first = container.children[0];
      const style = getComputedStyle(container);
      const gap = isMobile ?
        parseInt(style.columnGap) || parseInt(style.gap) || 8 :
        parseInt(style.rowGap) || parseInt(style.gap) || 8;

      if (isMobile) {
        const thumbWidth = first.offsetWidth;
        const fullWidth = thumbWidth + gap;
        return Math.max(1, Math.floor(container.clientWidth / fullWidth));
      } else {
        const thumbHeight = first.offsetHeight;
        const fullHeight = thumbHeight + gap;
        return Math.max(1, Math.floor(container.clientHeight / fullHeight));
      }
    }


    // === –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä ===
    function createThumbnails() {
      // –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è)
      if (galleryThumbnailsDesktop) {
        galleryThumbnailsDesktop.innerHTML = '';

        photos.forEach((photo, index) => {
          const thumbnail = createThumbnailElement(photo, index);

          thumbnail.addEventListener('click', (e) => {
            e.stopPropagation();
            changeGalleryImage(index);

            // –£–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ª—é–±—É—é –º–∏–Ω–∏–∞—Ç—é—Ä—É
            setTimeout(() => {
              scrollToThumbnailIfNeeded(index, 'desktop');
            }, 50);
          });

          galleryThumbnailsDesktop.appendChild(thumbnail);
        });
      }

      // –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è)
      if (galleryThumbnailsMobile) {
        galleryThumbnailsMobile.innerHTML = '';

        photos.forEach((photo, index) => {
          const thumbnail = createThumbnailElement(photo, index);

          thumbnail.addEventListener('click', (e) => {
            e.stopPropagation();
            changeGalleryImage(index);

            // –£–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ª—é–±—É—é –º–∏–Ω–∏–∞—Ç—é—Ä—É
            setTimeout(() => {
              scrollToThumbnailIfNeeded(index, 'mobile');
            }, 50);
          });

          galleryThumbnailsMobile.appendChild(thumbnail);
        });
      }

      updateThumbnailSelection();

      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –∞–∫—Ç–∏–≤–Ω–æ–π –º–∏–Ω–∏–∞—Ç—é—Ä–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
      setTimeout(() => {
        updateThumbnailSelection();
        scrollToThumbnailIfNeeded(currentGalleryIndex, window.innerWidth < 1024 ? 'mobile' : 'desktop');
      }, 100);
    }

    // === –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –º–∏–Ω–∏–∞—Ç—é—Ä—ã ===
    function createThumbnailElement(photo, index) {
      const thumbnail = document.createElement('div');
      thumbnail.className = 'relative w-16 h-16 rounded-md overflow-hidden cursor-pointer border-2 transition-all duration-200 flex-shrink-0 hover:border-blue-400 active:scale-95';
      thumbnail.style.borderColor = 'transparent';
      thumbnail.dataset.index = index;

      thumbnail.innerHTML = `
        <img
          src="${photo.thumb}"
          alt="${photo.alt}"
          class="w-full h-full object-cover"
          loading="lazy"
        />
        <div class="absolute inset-0 bg-black/30 opacity-0 hover:opacity-100 transition-opacity duration-200"></div>
      `;

      return thumbnail;
    }

    // === –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã –≤ –ø–∞–Ω–µ–ª–∏ ===
    function scrollToThumbnailIfNeeded(index, type = 'auto') {
      let container, isMobile;

      if (type === 'mobile' || (type === 'auto' && window.innerWidth < 1024)) {
        container = galleryThumbnailsMobile;
        isMobile = true;
      } else {
        container = galleryThumbnailsDesktop;
        isMobile = false;
      }

      if (!container) return;

      const thumbnails = Array.from(container.children);
      const thumbnail = thumbnails[index];
      if (!thumbnail) return;

      if (isMobile) {
        // –ú–æ–±–∏–ª—å–Ω–∞—è: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å
        const containerRect = container.getBoundingClientRect();
        const thumbRect = thumbnail.getBoundingClientRect();

        // –¶–µ–Ω—Ç—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        const containerCenter = container.scrollLeft + containerRect.width / 2;
        // –¶–µ–Ω—Ç—Ä –º–∏–Ω–∏–∞—Ç—é—Ä—ã –≤ viewport
        const thumbCenter = thumbRect.left + thumbRect.width / 2;

        // –°–º–µ—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã —Å–æ–≤–º–µ—Å—Ç–∏—Ç—å —Ü–µ–Ω—Ç—Ä—ã
        const scrollOffset = container.scrollLeft + (thumbCenter - containerRect.left - containerRect.width / 2);

        container.scrollTo({
          left: scrollOffset,
          behavior: "smooth"
        });
      } else {
        // –î–µ—Å–∫—Ç–æ–ø: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å
        const containerRect = container.getBoundingClientRect();
        const thumbRect = thumbnail.getBoundingClientRect();

        // –¶–µ–Ω—Ç—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        const containerCenter = container.scrollTop + containerRect.height / 2;
        // –¶–µ–Ω—Ç—Ä –º–∏–Ω–∏–∞—Ç—é—Ä—ã –≤ viewport
        const thumbCenter = thumbRect.top + thumbRect.height / 2;

        // –°–º–µ—â–µ–Ω–∏–µ
        const scrollOffset = container.scrollTop + (thumbCenter - containerRect.top - containerRect.height / 2);

        container.scrollTo({
          top: scrollOffset,
          behavior: "smooth"
        });
      }
    }



    // === –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–∏–Ω–∏–∞—Ç—é—Ä—ã ===
    function updateThumbnailSelection() {
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Å–∫—Ç–æ–ø
      if (galleryThumbnailsDesktop) {
        Array.from(galleryThumbnailsDesktop.children).forEach((thumb, i) => {
          const isActive = i === currentGalleryIndex;
          thumb.classList.toggle('active', isActive);
          thumb.style.borderColor = isActive ? '#3b82f6' : 'transparent';
        });
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ
      if (galleryThumbnailsMobile) {
        Array.from(galleryThumbnailsMobile.children).forEach((thumb, i) => {
          const isActive = i === currentGalleryIndex;
          thumb.classList.toggle('active', isActive);
          thumb.style.borderColor = isActive ? '#3b82f6' : 'transparent';
        });
      }

      // –°–∫—Ä–æ–ª–ª
      if (window.innerWidth < 1024) {
        scrollToThumbnailIfNeeded(currentGalleryIndex, 'mobile');
      } else {
        scrollToThumbnailIfNeeded(currentGalleryIndex, 'desktop');
      }
    }

    // === –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –≥–∞–ª–µ—Ä–µ–µ ===
    function changeGalleryImage(index) {
      if (index < 0 || index >= photos.length || index === currentGalleryIndex) return;

      resetZoom();
      currentGalleryIndex = index;
      updateGalleryImage();
      updateThumbnailSelection();
      updateInteractionTime();
    }

    // === –§—É–Ω–∫—Ü–∏—è "—É–º–Ω–æ–≥–æ" –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ —Å—Ç—Ä–µ–ª–∫–∞–º (—Å –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ–º) ===
    function smartNavigate(direction) {
      // direction: -1 –¥–ª—è prev, +1 –¥–ª—è next
      let newIndex = currentGalleryIndex + direction;

      // –ó–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ: –µ—Å–ª–∏ –≤—ã—à–ª–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
      if (newIndex < 0) {
        newIndex = photos.length - 1; // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É
      } else if (newIndex >= photos.length) {
        newIndex = 0; // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–µ—Ä–≤–æ–º—É
      }

      // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–∞
      if (newIndex === currentGalleryIndex) return;

      resetZoom(); // –°–±—Ä–æ—Å –∑—É–º–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ
      currentGalleryIndex = newIndex;
      updateGalleryImage();
      updateThumbnailSelection();

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–æ–ª–ª –∫ –º–∏–Ω–∏–∞—Ç—é—Ä–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞
      setTimeout(() => {
        scrollToThumbnailIfNeeded(currentGalleryIndex, window.innerWidth < 1024 ? 'mobile' : 'desktop');
      }, 100);

      updateInteractionTime();
    }

    // === –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–æ–º ===
    function setZoomInCursor() {
      galleryImg.classList.remove('cursor-grab', 'cursor-grabbing', 'cursor-zoom-out');
      galleryImg.classList.add('cursor-zoom-in');
    }

    function setGrabCursor() {
      galleryImg.classList.remove('cursor-zoom-in', 'cursor-grabbing', 'cursor-zoom-out');
      galleryImg.classList.add('cursor-grab');
    }

    function resetCursor() {
      if (isZoomed) {
        if (window.matchMedia('(hover: hover)').matches && !isTouchDevice()) {
          galleryImg.classList.remove('cursor-grab', 'cursor-grabbing', 'cursor-zoom-in');
          galleryImg.classList.add('cursor-zoom-out');
        } else {
          setGrabCursor();
        }
      } else {
        setZoomInCursor();
      }
    }

    function isTouchDevice() {
      return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    }

    // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è ===
    function updateInteractionTime() {
      lastInteractionTime = Date.now();
    }

    // === –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –∑—É–º–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö ===
    function startAutoResetTimer() {
      if (!isTouchDevice() || !isZoomed) return;

      clearTimeout(autoResetZoomTimer);
      autoResetZoomTimer = setTimeout(() => {
        if (isZoomed && Date.now() - lastInteractionTime >= MOBILE_AUTO_RESET_DELAY) {
          resetZoom();
        }
      }, MOBILE_AUTO_RESET_DELAY);
    }

    // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã–º —Ä–µ–∂–∏–º–æ–º (–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞ –∫—É—Ä—Å–æ—Ä–æ–º) ===
    function enableDesktopZoomMode() {
      if (isDesktopZoomMode) return;
      isDesktopZoomMode = true;
      galleryImageContainer.addEventListener('mousemove', handleDesktopPan);
      galleryImageContainer.addEventListener('mouseleave', handleDesktopMouseLeave);
    }

    function disableDesktopZoomMode() {
      if (!isDesktopZoomMode) return;
      isDesktopZoomMode = false;
      galleryImageContainer.removeEventListener('mousemove', handleDesktopPan);
      galleryImageContainer.removeEventListener('mouseleave', handleDesktopMouseLeave);
    }

    function handleDesktopPan(e) {
      if (!isZoomed || isTouchDevice()) return;

      const rect = galleryImageContainer.getBoundingClientRect();

      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      const posX = mouseX / rect.width;
      const posY = mouseY / rect.height;

      const scaledWidth = galleryImg.naturalWidth * currentScale;
      const scaledHeight = galleryImg.naturalHeight * currentScale;

      const maxX = Math.max(0, (scaledWidth - rect.width) / 2);
      const maxY = Math.max(0, (scaledHeight - rect.height) / 2);

      translateX = maxX - posX * (maxX * 2);
      translateY = maxY - posY * (maxY * 2);

      applyTransform();
    }


    function handleDesktopMouseLeave() {
      // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –ø—Ä–∏ —É—Ö–æ–¥–µ –∫—É—Ä—Å–æ—Ä–∞ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∑—É–º
      if (isZoomed && !isTouchDevice()) {
        resetZoom();
      }
    }

    // === –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è ===
    function zoomToDefault() {
      currentScale = (MIN_ZOOM + MAX_ZOOM) / 2;
      isZoomed = true;

      expandContainer();
      applyTransform();
      updateZoomIndicator();
      updateInteractionTime();

      if (window.matchMedia('(hover: hover)').matches && !isTouchDevice()) {
        enableDesktopZoomMode();
        galleryImg.classList.remove('cursor-grab', 'cursor-grabbing', 'cursor-zoom-in');
        galleryImg.classList.add('cursor-zoom-out');
      } else {
        setGrabCursor();
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞ –∑—É–º–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        if (galleryResetZoom) {
          galleryResetZoom.classList.remove('hidden');
        }
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –∞–≤—Ç–æ—Å–±—Ä–æ—Å–∞
        startAutoResetTimer();
      }
    }

    function resetZoom() {
      currentScale = 1;
      translateX = 0;
      translateY = 0;
      isZoomed = false;

      resetContainer();
      applyTransform();
      updateZoomIndicator(); // ‚Üê –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–∫–æ–Ω–∫—É
      updateInteractionTime();

      disableDesktopZoomMode();
      setZoomInCursor();

      // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞ –∑—É–º–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
      if (galleryResetZoom) {
        galleryResetZoom.classList.add('hidden');
      }

      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –∞–≤—Ç–æ—Å–±—Ä–æ—Å–∞
      clearTimeout(autoResetZoomTimer);
    }

    function toggleZoom() {
      updateInteractionTime();
      if (isZoomed) {
        resetZoom();
      } else {
        zoomToDefault();
      }
    }

    function toggleZoom() {
      updateInteractionTime();
      if (isZoomed) {
        resetZoom();
      } else {
        zoomToDefault();
      }
    }

    function zoomIn() {
      const newScale = Math.min(currentScale + ZOOM_STEP, MAX_ZOOM);
      if (newScale !== currentScale) {
        currentScale = newScale;
        isZoomed = true;
        expandContainer();
        applyTransform();
        updateZoomIndicator();
        resetCursor();
        updateInteractionTime();
        startAutoResetTimer();
      }
    }

    function zoomOut() {
      const newScale = Math.max(currentScale - ZOOM_STEP, MIN_ZOOM);
      if (newScale !== currentScale) {
        currentScale = newScale;
        isZoomed = true;
        expandContainer();
        applyTransform();
        updateZoomIndicator();
        resetCursor();
        updateInteractionTime();
        startAutoResetTimer();
      }
    }

    function expandContainer() {
      galleryImageContainer.classList.remove('max-w-full', 'max-h-[calc(90vh-2rem)]', 'max-h-[calc(90vh-4rem)]', 'lg:max-h-[90vh]');

      if (window.innerWidth < 1024) {
        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - —É–º–µ–Ω—å—à–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–æ –º–∏–Ω–∏–∞—Ç—é—Ä—ã
        galleryImageContainer.classList.add('max-w-[95vw]', 'max-h-[calc(85vh-2rem)]', 'overflow-auto', 'mb-8');
      } else {
        galleryImageContainer.classList.add('lg:max-w-[calc(95vw-6rem)]', 'max-w-[95vw]', 'max-h-[90vh]', 'overflow-auto');
      }

      galleryImg.classList.remove('max-w-full', 'max-h-[calc(90vh-2rem)]', 'lg:max-h-[90vh]');
      galleryImg.classList.add('max-w-none', 'max-h-none');
    }

    function resetContainer() {
      galleryImageContainer.classList.remove(
        'lg:max-w-[calc(95vw-2rem)]', 'max-w-[95vw]',
        'max-h-[calc(85vh-2rem)]', 'max-h-[90vh]',
        'overflow-auto', 'mb-20'
      );

      galleryImageContainer.classList.add('max-w-full', 'max-h-[calc(90vh-4rem)]', 'lg:max-h-[90vh]', 'mb-2', 'lg:mb-0');
      galleryImg.classList.remove('max-w-none', 'max-h-none');
      galleryImg.classList.add('max-w-full', 'max-h-[calc(90vh-2rem)]', 'lg:max-h-[90vh]');
    }

    function applyTransform() {
      galleryImg.style.transform =
        `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
    }


    function updateZoomIndicator() {
      if (galleryZoomIndicator) {
        if (isZoomed) {
          galleryZoomIndicator.classList.remove('hidden');
          document.getElementById('gallery-zoom-text').textContent = Math.round(currentScale * 100) + '%';
          updateZoomIcon(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
        } else {
          galleryZoomIndicator.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
          document.getElementById('gallery-zoom-text').textContent = Math.round(currentScale * 100) + '%';
          updateZoomIcon(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
        }
      }
    }

    // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∏–∫–æ–Ω–∫–µ –∑—É–º–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö) ===
    const zoomIcon = document.getElementById('gallery-zoom-icon');
    if (zoomIcon) {
      zoomIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleZoom();
      });
    }

    function updateZoomIcon() {
      const icon = document.getElementById('gallery-zoom-icon');
      if (!icon) return;

      if (currentScale <= 1) {
        // –õ—É–ø–∞ —Å +
        icon.innerHTML = `
      <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0zm-4 0H7m3-3v6m-3-3h6" />
    `;
      } else {
        // –õ—É–ø–∞ —Å -
        icon.innerHTML = `
      <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0zm-4 0H7" />
    `;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ body
    function lockBodyScroll() {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —à–∏—Ä–∏–Ω—É —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞, —á—Ç–æ–±—ã –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å —Å–º–µ—â–µ–Ω–∏–µ
      const scrollBarWidth = window.innerWidth - document.documentElement.clientWidth;

      // –§–∏–∫—Å–∏—Ä—É–µ–º body: –æ—Ç–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞
      document.body.style.overflow = 'hidden';
      document.body.style.paddingRight = scrollBarWidth + 'px';
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ body
    function unlockBodyScroll() {
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
    }

    // === –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –≥–∞–ª–µ—Ä–µ–∏ ===
    mainImageContainer?.addEventListener('click', () => {
      currentGalleryIndex = currentMainIndex;
      resetZoom();
      createThumbnails(); // –°–æ–∑–¥–∞—ë–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
      updateGalleryImage();

      // üîí –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
      lockBodyScroll();

      galleryModal.classList.remove('hidden', 'pointer-events-none');
      setTimeout(() => {
        galleryModal.classList.add('opacity-100', 'pointer-events-auto');
        updateInteractionTime();
      }, 10);
    });

    function closeGallery() {
      resetZoom();
      galleryModal.classList.remove('opacity-100', 'pointer-events-auto');

      // üîì –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
      setTimeout(() => {
        galleryModal.classList.add('hidden', 'pointer-events-none');
        unlockBodyScroll(); // ‚Üê –≤–æ—Ç –∑–¥–µ—Å—å
      }, 300);

      clearTimeout(autoResetZoomTimer);
    }

    galleryClose?.addEventListener('click', closeGallery);
    galleryModal?.addEventListener('click', (e) => {
      if (e.target === galleryModal) closeGallery();
    });

    // === –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –∑—É–º–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö ===
    if (galleryResetZoom) {
      galleryResetZoom.addEventListener('click', resetZoom);
    }

    // === –ù–∞–≤–∏–≥–∞—Ü–∏—è ===
    galleryPrev?.addEventListener('click', (e) => {
      e.stopPropagation();
      smartNavigate(-1);
    });

    galleryNext?.addEventListener('click', (e) => {
      e.stopPropagation();
      smartNavigate(1);
    });

    function updateGalleryImage() {
      const photo = photos[currentGalleryIndex];
      galleryImg.src = photo.src;
      galleryImg.alt = photo.alt;
      resetZoom(); // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Å–±—Ä–æ—Å –ø—Ä–∏ —Å–º–µ–Ω–µ
      if (galleryCounter) {
        galleryCounter.textContent = `${currentGalleryIndex + 1} / ${photos.length}`;
      }
      updateInteractionTime();
      updateZoomIndicator(); // ‚Üê –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏ —Å–º–µ–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    }

    // === –ö–ª–∏–∫ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑—É–º–∞ ===
    galleryImg.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleZoom();
    });

    // === –¢–æ–ª—å–∫–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö: drag –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ===
    galleryImg.addEventListener('touchstart', (e) => {
      if (!isZoomed || e.touches.length !== 1) return;
      e.preventDefault();
      isDragging = true;
      startX = e.touches[0].clientX - translateX;
      startY = e.touches[0].clientY - translateY;
      setGrabCursor();
      document.addEventListener('touchmove', drag);
      document.addEventListener('touchend', endDrag);
      updateInteractionTime();
      startAutoResetTimer();
    });

    // === –°–≤–∞–π–ø –ø–æ –æ—Å–Ω–æ–≤–Ω–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï —É–≤–µ–ª–∏—á–µ–Ω–æ) ===
    galleryImageContainer.addEventListener('touchstart', (e) => {
      if (isZoomed || e.touches.length !== 1) return;
      touchStartX = e.touches[0].clientX;
    }, { passive: true });

    galleryImageContainer.addEventListener('touchend', (e) => {
      if (isZoomed || e.changedTouches.length !== 1) return;
      touchEndX = e.changedTouches[0].clientX;

      const diff = touchStartX - touchEndX;

      // –°–≤–∞–π–ø –≤–ª–µ–≤–æ ‚Üí —Å–ª–µ–¥—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      if (diff > SWIPE_THRESHOLD) {
        smartNavigate(1); // ‚Üê –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é
      }
      // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ ‚Üí –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      else if (diff < -SWIPE_THRESHOLD) {
        smartNavigate(-1); // ‚Üê –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é
      }
    }, { passive: true });

    function drag(e) {
      if (!isDragging || !isZoomed) return;

      e.preventDefault();

      const touch = e.touches[0];
      const dx = touch.clientX - startX;
      const dy = touch.clientY - startY;

      const rect = galleryImageContainer.getBoundingClientRect();

      const scaledWidth = galleryImg.naturalWidth * currentScale;
      const scaledHeight = galleryImg.naturalHeight * currentScale;

      const maxX = Math.max(0, (scaledWidth - rect.width) / 2);
      const maxY = Math.max(0, (scaledHeight - rect.height) / 2);

      translateX = Math.max(-maxX, Math.min(maxX, dx));
      translateY = Math.max(-maxY, Math.min(maxY, dy));

      applyTransform();
    }


    function endDrag() {
      if (!isDragging) return;
      isDragging = false;
      document.removeEventListener('touchmove', drag);
      document.removeEventListener('touchend', endDrag);
      resetCursor();
      updateInteractionTime();
      startAutoResetTimer();
    }

    // === –ö–æ–ª–µ—Å–æ –º—ã—à–∏ ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤ –¥–µ—Å–∫—Ç–æ–ø-—Ä–µ–∂–∏–º–µ ===
    galleryImageContainer.addEventListener('wheel', (e) => {
      if (!isZoomed || isTouchDevice()) return;
      e.preventDefault();
      if (e.deltaY < 0) zoomIn();
      else zoomOut();
      updateInteractionTime();
    }, { passive: false });

    // === –ñ–µ—Å—Ç—ã (–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ) –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö ===
    let initialDistance = 0;
    let initialScale = 1;

    galleryImageContainer.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        initialDistance = getDistance(e.touches[0], e.touches[1]);
        initialScale = currentScale;
        updateInteractionTime();
      }
    });

    galleryImageContainer.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const currentDistance = getDistance(e.touches[0], e.touches[1]);
        const scaleFactor = currentDistance / initialDistance;
        const newScale = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, initialScale * scaleFactor));
        if (newScale !== currentScale) {
          currentScale = newScale;
          isZoomed = true;
          expandContainer();
          applyTransform();
          updateZoomIndicator();
          setGrabCursor();
          updateInteractionTime();
          startAutoResetTimer();
        }
      }
    });

    function getDistance(touch1, touch2) {
      const dx = touch1.clientX - touch2.clientX;
      const dy = touch1.clientY - touch2.clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }

    // === –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ ===
    window.addEventListener('keydown', (e) => {
      if (!galleryModal.classList.contains('opacity-100')) return;

      if (e.key === 'Escape') {
        if (isZoomed) resetZoom();
        else closeGallery();
      } else if (e.key === 'ArrowLeft') {
        smartNavigate(-1);
      } else if (e.key === 'ArrowRight') {
        smartNavigate(1);
      } else if (e.key === 'ArrowUp') {
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: —Å–∫—Ä–æ–ª–ª –≤–≤–µ—Ä—Ö –ø–æ –º–∏–Ω–∏–∞—Ç—é—Ä–∞–º –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ
        if (window.innerWidth >= 1024 && galleryThumbnailsDesktop) {
          e.preventDefault();
          galleryThumbnailsDesktop.scrollBy({ top: -80, behavior: 'smooth' });
        }
      } else if (e.key === 'ArrowDown') {
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: —Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –ø–æ –º–∏–Ω–∏–∞—Ç—é—Ä–∞–º –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ
        if (window.innerWidth >= 1024 && galleryThumbnailsDesktop) {
          e.preventDefault();
          galleryThumbnailsDesktop.scrollBy({ top: 80, behavior: 'smooth' });
        }
      } else if (e.key === '0') resetZoom();
      else if (e.key === '1') zoomToDefault();
      else if (e.key === '+' || e.key === '=') zoomIn();
      else if (e.key === '-' || e.key === '_') zoomOut();

      updateInteractionTime();
    });

    // === –°–º–µ–Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∏–Ω–∏–∞—Ç—é—Ä—ã) ===
    const infoDots = document.getElementById('infoDots');

    function changeMainImage(thumb) {
      const bigImage = thumb.dataset.bigimage;
      const alt = thumb.alt;
      const index = parseInt(thumb.dataset.index, 10);

      if (!mainImage || !bigImage || isNaN(index)) return;

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
      document.querySelectorAll('.slider-track img').forEach(img => {
        img.style.borderColor = '';
      });
      thumb.style.setProperty('border-color', '#2563eb', 'important');

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å
      currentMainIndex = index;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      if (infoDots) {
        infoDots.classList.toggle('hidden', index !== 0);
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      const tempImg = new Image();
      tempImg.onload = () => {
        mainImage.src = bigImage; // —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        mainImage.alt = alt;
        requestAnimationFrame(refreshSlider);
      };
      tempImg.onerror = () => {
        mainImage.src = bigImage;
        mainImage.alt = alt;
        requestAnimationFrame(refreshSlider);
      };
      tempImg.src = bigImage; // –∑–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä
    const firstThumb = document.querySelector('.slider-track img');
    if (firstThumb) {
      currentMainIndex = parseInt(firstThumb.dataset.index, 10) || 0;
      changeMainImage(firstThumb);
    }

    document.querySelectorAll('.slider-track img').forEach(img => {
      img.addEventListener('click', () => changeMainImage(img));
    });

    // === –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–ª–∞–π–¥–µ—Ä–∞ –º–∏–Ω–∏–∞—Ç—é—Ä (–æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∞—à—É –ª–æ–≥–∏–∫—É) ===
    function updateThumbnailSliderHeight() {
      const track = document.querySelector('.slider-track');
      const container = document.querySelector(".slider-thumbnails-container > .relative");

      // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç ‚Äî –≤—ã—Ö–æ–¥–∏–º
      if (!track || !container) return;

      if (window.innerWidth < 1024) {
        // === –ú–æ–±–∏–ª—å–Ω—ã–π —Ä–µ–∂–∏–º: —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –í–°–Å (—à–∏—Ä–∏–Ω–∞ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É –∏–ª–∏ 100%) ===
        track.style.height = '';
        track.style.maxHeight = '';
        track.style.width = '';
        track.style.minWidth = '';
        track.style.maxWidth = '';

        container.style.height = '';
        container.style.maxHeight = '';
        container.style.width = '';
        container.style.minWidth = '';
        container.style.maxWidth = '';

        return;
      }

      // === –î–µ—Å–∫—Ç–æ–ø–Ω—ã–π —Ä–µ–∂–∏–º (>=1024px) ===
      const mainImageEl = document.querySelector('#mainImageContainer > img');
      if (!mainImageEl) return;

      const imageHeight = mainImageEl.getBoundingClientRect().height;
      if (imageHeight <= 0) return;

      const btnHeight = 20; // –≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–æ–∫ "–≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑"
      const gap = 16;       // —Å—É–º–º–∞—Ä–Ω—ã–π gap –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ –∏ —Ç—Ä–µ–∫–æ–º
      const desiredTrackHeight = imageHeight - btnHeight * 2 - gap;
      const finalTrackHeight = desiredTrackHeight > 100 ? desiredTrackHeight : 400;

      // --- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ö–û–ù–¢–ï–ô–ù–ï–†–ê (–æ–±—ë—Ä—Ç–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏) ---
      container.style.height = imageHeight + 'px';
      container.style.maxHeight = imageHeight + 'px';
      container.style.width = '80px';
      container.style.minWidth = '80px';
      container.style.maxWidth = '80px';
    }

    function refreshSlider() {
      updateThumbnailSliderHeight();
    }

    // === –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å–∞–π–∑–∞ –æ–∫–Ω–∞ ===
    function handleResize() {
      refreshSlider();
      // –ü—Ä–∏ —Ä–µ—Å–∞–π–∑–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∑—É–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      if (isZoomed) {
        resetZoom();
      }
      // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã
      if (galleryModal.classList.contains('opacity-100')) {
        updateThumbnailSelection();
      }
    }

    window.addEventListener('load', refreshSlider);
    window.addEventListener('resize', handleResize);
    mainImage?.addEventListener('load', refreshSlider);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    setZoomInCursor();
  });
</script>
