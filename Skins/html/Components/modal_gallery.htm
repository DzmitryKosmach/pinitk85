<!-- Модальное окно галереи -->
<div
  id="gallery-modal"
  class="fixed inset-0 bg-black bg-opacity-90 z-[999] items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300 hidden"
>
  <!-- Левая панель миниатюр (десктоп) -->
  <div
    id="gallery-thumbnails-desktop"
    class="hidden lg:block absolute left-4 top-4 bottom-4 w-20 flex flex-col items-center py-2 space-y-2 overflow-y-auto overflow-x-hidden z-[60]"
  >
    <!-- Миниатюры будут добавляться динамически -->
  </div>

  <!-- Нижняя панель миниатюр (мобильные) -->
  <div
    id="gallery-thumbnails-mobile"
    class="lg:hidden absolute bottom-4 left-4 right-4 h-20 flex items-center overflow-x-auto overflow-y-hidden py-2 space-x-2 z-[60] scrollbar-none"
  >
    <!-- Миниатюры будут добавляться динамически -->
  </div>

  <!-- Центральное изображение -->
  <div
    id="gallery-image-container"
    class="relative h-full flex items-center justify-center rounded-xl overflow-hidden transition-all duration-300 ease-out lg:ml-24 mb-8 lg:mb-0"
  >
    <img
      id="gallery-main-img"
      src=""
      alt=""
      class="max-w-full max-h-[calc(90vh-2rem)] lg:max-h-[90vh] object-contain shadow-2xl transition-transform duration-300 ease-out cursor-zoom-in"
    />
  </div>

  <!-- Кнопка закрытия -->
  <button
    id="gallery-close"
    class="absolute top-4 right-4 text-white/90 hover:text-white text-lg font-light z-[61] bg-black/40 backdrop-blur-sm rounded-full w-10 h-10 flex items-center justify-center transition-all duration-200 ease-in-out hover:bg-black/60"
    aria-label="Закрыть галерею"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>

  <!-- Стрелка "назад" -->
  <button
    id="gallery-prev"
    class="absolute lg:left-28 left-4 top-[calc(50%-2.2rem)] -translate-y-1/2 z-[61] p-3 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-sm text-white transition-all duration-200 ease-in-out hover:scale-105 focus:outline-none focus:ring-2 focus:ring-white/40"
    aria-label="Предыдущее изображение"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
    </svg>
  </button>

  <!-- Стрелка "вперёд" -->
  <button
    id="gallery-next"
    class="absolute right-4 top-[calc(50%-2.2rem)] -translate-y-1/2 z-[61] p-3 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-sm text-white transition-all duration-200 ease-in-out hover:scale-105 focus:outline-none focus:ring-2 focus:ring-white/40"
    aria-label="Следующее изображение"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
    </svg>
  </button>

  <!-- Счётчик -->
  <div
    id="gallery-counter"
    class="absolute lg:bottom-4 bottom-28 left-1/2 -translate-x-1/2 text-white/80 text-sm font-mono tracking-wide bg-black/30 px-3 py-1.5 rounded-full backdrop-blur-sm z-[62]"
  ></div>

  <!-- Индикатор масштаба -->
  <div
    id="gallery-zoom-indicator"
    class="absolute top-4 lg:left-28 left-4 text-white/80 text-sm font-mono tracking-wide bg-black/30 px-3 py-1.5 rounded-full backdrop-blur-sm hidden z-[62]"
  >
    100%
  </div>

  <!-- Кнопка сброса зума (только для мобильных) -->
  <button
    id="gallery-reset-zoom"
    class="lg:hidden absolute bottom-24 right-4 text-white/90 text-sm font-light z-[61] bg-black/60 backdrop-blur-sm rounded-full w-10 h-10 flex items-center justify-center transition-all duration-200 ease-in-out hover:bg-black/80 hidden"
    aria-label="Сбросить масштаб"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7" />
    </svg>
  </button>
</div>

<?php
$photosUnified = [];

// --- Если это ФОТО ТОВАРА (присутствует rm) ---
if (isset($photos[0]['rm'])) {

    foreach ($photos as $p) {
        $photosUnified[] = [
            'src'   => Catalog::photoUrl(
Catalog_Series_Photos::$imagePath,
$p['id'], 0, 0, 0, $p['_img_ext'],
[$catInf['url'], $seriesInf['url']]
),
'thumb' => Catalog::photoUrl(
Catalog_Series_Photos::$imagePath,
$p['id'], 90, 90, $p['rm'], $p['_img_ext']
),
'alt'   => hsch(
trim($p['alt'])
? $p['alt']
: $catInf['name'] . ' ' . $seriesInf['name']
),
'highslide' => false
];
}
}

// --- Если это ФОТО ПРОЕКТА ---
else {


foreach ($photos as $i => $p) {

// большие изображения
$src = Config::pathRel('images') .
Clients_Projects_Pics::$imagePath .
$p['id'] . '_0x0_1_wm.' . $p['_img_ext'];

// миниатюры
$thumb = Config::pathRel('images') .
Clients_Projects_Pics::$imagePath .
$p['id'] .
($i === 0 ? '_290x255_0_wm.' : '_197x153_0_wm.') .
$p['_img_ext'];

$photosUnified[] = [
'src'       => $src,
'thumb'     => $thumb,
'alt'       => hsch($p['alt']),
'highslide' => true
];
}
}
?>

<style>
  /* Скрываем скроллбар для всех элементов */
  .scrollbar-none {
    -ms-overflow-style: none;  /* IE и Edge */
    scrollbar-width: none;     /* Firefox */
  }

  .scrollbar-none::-webkit-scrollbar {
    display: none; /* Chrome, Safari и Opera */
  }

  /* Стили для десктопных миниатюр */
  #gallery-thumbnails-desktop {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  #gallery-thumbnails-desktop::-webkit-scrollbar {
    display: none;
  }

  /* Плавный скролл для миниатюр */
  #gallery-thumbnails-desktop,
  #gallery-thumbnails-mobile {
    scroll-behavior: smooth;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // === ГАЛЕРЕЯ: данные ===

    const photos = <?= json_encode($photosUnified, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES) ?>;

    let currentGalleryIndex = 0;
    let isZoomed = false;
    let isDragging = false; // только для мобильных
    let startX, startY;
    let translateX = 0, translateY = 0;
    let currentScale = 1;
    let isDesktopZoomMode = false;
    let currentMainIndex = 0;
    let autoResetZoomTimer = null;
    let lastInteractionTime = Date.now();

    // === НАСТРОЙКИ МАСШТАБИРОВАНИЯ ===
    const MIN_ZOOM = 1.2;
    const MAX_ZOOM = 2.0;
    const ZOOM_STEP = 0.1;
    const MOBILE_AUTO_RESET_DELAY = 3000; // 3 секунды бездействия

    // === Элементы DOM ===
    const mainImage = document.getElementById('main-product-image');
    const mainImageContainer = document.getElementById('mainImageContainer');
    const galleryModal = document.getElementById('gallery-modal');
    const galleryImg = document.getElementById('gallery-main-img');
    const galleryImageContainer = document.getElementById('gallery-image-container');
    const galleryClose = document.getElementById('gallery-close');
    const galleryPrev = document.getElementById('gallery-prev');
    const galleryNext = document.getElementById('gallery-next');
    const galleryCounter = document.getElementById('gallery-counter');
    const galleryZoomIndicator = document.getElementById('gallery-zoom-indicator');
    const galleryResetZoom = document.getElementById('gallery-reset-zoom');
    const galleryThumbnailsDesktop = document.getElementById('gallery-thumbnails-desktop');
    const galleryThumbnailsMobile = document.getElementById('gallery-thumbnails-mobile');

    // === Функция создания миниатюр ===
    function createThumbnails() {
      // Десктопная версия (вертикальная)
      if (galleryThumbnailsDesktop) {
        galleryThumbnailsDesktop.innerHTML = '';

        photos.forEach((photo, index) => {
          const thumbnail = createThumbnailElement(photo, index);

          thumbnail.addEventListener('click', (e) => {
            e.stopPropagation();
            changeGalleryImage(index);
          });

          galleryThumbnailsDesktop.appendChild(thumbnail);
        });
      }

      // Мобильная версия (горизонтальная)
      if (galleryThumbnailsMobile) {
        galleryThumbnailsMobile.innerHTML = '';

        photos.forEach((photo, index) => {
          const thumbnail = createThumbnailElement(photo, index);

          thumbnail.addEventListener('click', (e) => {
            e.stopPropagation();
            changeGalleryImage(index);

            // Умный скролл при клике на любую миниатюру
            scrollToThumbnailIfNeeded(index, 'mobile');
          });

          galleryThumbnailsMobile.appendChild(thumbnail);
        });
      }

      updateThumbnailSelection();

      // Добавляем обработчики для умного скролла на десктопе
      if (galleryThumbnailsDesktop) {
        const desktopThumbs = galleryThumbnailsDesktop.querySelectorAll('div');
        desktopThumbs.forEach((thumb, index) => {
          thumb.addEventListener('click', () => {
            scrollToThumbnailIfNeeded(index, 'desktop');
          });
        });
      }
    }

    // === Создание элемента миниатюры ===
    function createThumbnailElement(photo, index) {
      const thumbnail = document.createElement('div');
      thumbnail.className = 'relative w-16 h-16 rounded-md overflow-hidden cursor-pointer border-2 transition-all duration-200 flex-shrink-0 hover:border-blue-400 active:scale-95';
      thumbnail.style.borderColor = 'transparent';
      thumbnail.dataset.index = index;

      thumbnail.innerHTML = `
        <img
          src="${photo.thumb}"
          alt="${photo.alt}"
          class="w-full h-full object-cover"
          loading="lazy"
        />
        <div class="absolute inset-0 bg-black/30 opacity-0 hover:opacity-100 transition-opacity duration-200"></div>
      `;

      return thumbnail;
    }

    // === Функция для умного скролла к миниатюре ===
    function scrollToThumbnailIfNeeded(index, type = 'auto') {
      let container, thumbnails;

      if (type === 'mobile' || (type === 'auto' && window.innerWidth < 1024)) {
        container = galleryThumbnailsMobile;
        if (!container) return;
        thumbnails = container.querySelectorAll('div');
      } else {
        container = galleryThumbnailsDesktop;
        if (!container) return;
        thumbnails = container.querySelectorAll('div');
      }

      if (!thumbnails[index]) return;

      const thumbnail = thumbnails[index];
      const containerRect = container.getBoundingClientRect();
      const thumbnailRect = thumbnail.getBoundingClientRect();

      // Для горизонтального скролла (мобильные)
      if (container === galleryThumbnailsMobile) {
        const isFullyVisible =
          thumbnailRect.left >= containerRect.left &&
          thumbnailRect.right <= containerRect.right;

        if (!isFullyVisible) {
          if (thumbnailRect.left < containerRect.left) {
            // Миниатюра слева за границей
            container.scrollTo({
              left: thumbnail.offsetLeft - 16,
              behavior: 'smooth'
            });
          } else if (thumbnailRect.right > containerRect.right) {
            // Миниатюра справа за границей
            const scrollLeft = thumbnail.offsetLeft - container.clientWidth + thumbnail.clientWidth + 16;
            container.scrollTo({
              left: scrollLeft,
              behavior: 'smooth'
            });
          }
        }
      }
      // Для вертикального скролла (десктоп)
      else if (container === galleryThumbnailsDesktop) {
        const isFullyVisible =
          thumbnailRect.top >= containerRect.top &&
          thumbnailRect.bottom <= containerRect.bottom;

        if (!isFullyVisible) {
          if (thumbnailRect.top < containerRect.top) {
            // Миниатюра сверху за границей
            container.scrollTo({
              top: thumbnail.offsetTop - 16,
              behavior: 'smooth'
            });
          } else if (thumbnailRect.bottom > containerRect.bottom) {
            // Миниатюра снизу за границей
            const scrollTop = thumbnail.offsetTop - container.clientHeight + thumbnail.clientHeight + 16;
            container.scrollTo({
              top: scrollTop,
              behavior: 'smooth'
            });
          }
        }
      }
    }

    // === Функция обновления выбранной миниатюры ===
    function updateThumbnailSelection() {
      // Десктопные миниатюры
      if (galleryThumbnailsDesktop) {
        const desktopThumbs = galleryThumbnailsDesktop.querySelectorAll('div');
        desktopThumbs.forEach((thumb, index) => {
          if (index === currentGalleryIndex) {
            thumb.style.borderColor = '#3b82f6'; // blue-500
            thumb.style.borderWidth = '2px';
          } else {
            thumb.style.borderColor = 'transparent';
            thumb.style.borderWidth = '2px';
          }
        });
      }

      // Мобильные миниатюры
      if (galleryThumbnailsMobile) {
        const mobileThumbs = galleryThumbnailsMobile.querySelectorAll('div');
        mobileThumbs.forEach((thumb, index) => {
          if (index === currentGalleryIndex) {
            thumb.style.borderColor = '#3b82f6'; // blue-500
            thumb.style.borderWidth = '2px';
          } else {
            thumb.style.borderColor = 'transparent';
            thumb.style.borderWidth = '2px';
          }
        });
      }

      // Автоматический скролл к выбранной миниатюре
      if (window.innerWidth < 1024) {
        scrollToThumbnailIfNeeded(currentGalleryIndex, 'mobile');
      } else {
        scrollToThumbnailIfNeeded(currentGalleryIndex, 'desktop');
      }
    }

    // === Функция смены изображения в галерее ===
    function changeGalleryImage(index) {
      if (index < 0 || index >= photos.length || index === currentGalleryIndex) return;

      resetZoom();
      currentGalleryIndex = index;
      updateGalleryImage();
      updateThumbnailSelection();
      updateInteractionTime();
    }

    // === Функции управления курсором ===
    function setZoomInCursor() {
      galleryImg.classList.remove('cursor-grab', 'cursor-grabbing', 'cursor-zoom-out');
      galleryImg.classList.add('cursor-zoom-in');
    }

    function setGrabCursor() {
      galleryImg.classList.remove('cursor-zoom-in', 'cursor-grabbing', 'cursor-zoom-out');
      galleryImg.classList.add('cursor-grab');
    }

    function resetCursor() {
      if (isZoomed) {
        if (window.matchMedia('(hover: hover)').matches && !isTouchDevice()) {
          galleryImg.classList.remove('cursor-grab', 'cursor-grabbing', 'cursor-zoom-in');
          galleryImg.classList.add('cursor-zoom-out');
        } else {
          setGrabCursor();
        }
      } else {
        setZoomInCursor();
      }
    }

    function isTouchDevice() {
      return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    }

    // === Обновление времени последнего взаимодействия ===
    function updateInteractionTime() {
      lastInteractionTime = Date.now();
    }

    // === Автоматический сброс зума на мобильных ===
    function startAutoResetTimer() {
      if (!isTouchDevice() || !isZoomed) return;

      clearTimeout(autoResetZoomTimer);
      autoResetZoomTimer = setTimeout(() => {
        if (isZoomed && Date.now() - lastInteractionTime >= MOBILE_AUTO_RESET_DELAY) {
          resetZoom();
        }
      }, MOBILE_AUTO_RESET_DELAY);
    }

    // === Управление десктопным режимом (перемещение за курсором) ===
    function enableDesktopZoomMode() {
      if (isDesktopZoomMode) return;
      isDesktopZoomMode = true;
      galleryImageContainer.addEventListener('mousemove', handleDesktopPan);
      galleryImageContainer.addEventListener('mouseleave', handleDesktopMouseLeave);
    }

    function disableDesktopZoomMode() {
      if (!isDesktopZoomMode) return;
      isDesktopZoomMode = false;
      galleryImageContainer.removeEventListener('mousemove', handleDesktopPan);
      galleryImageContainer.removeEventListener('mouseleave', handleDesktopMouseLeave);
    }

    function handleDesktopPan(e) {
      if (!isZoomed || isTouchDevice()) return;

      updateInteractionTime();

      const containerRect = galleryImageContainer.getBoundingClientRect();
      const imgRect = galleryImg.getBoundingClientRect();

      // Размеры видимой области и полного масштабированного изображения
      const containerWidth = containerRect.width;
      const containerHeight = containerRect.height;
      const scaledImgWidth = imgRect.width * currentScale;
      const scaledImgHeight = imgRect.height * currentScale;

      // Если изображение не выходит за границы — ничего не двигаем
      if (scaledImgWidth <= containerWidth && scaledImgHeight <= containerHeight) {
        translateX = 0;
        translateY = 0;
        applyTransform();
        return;
      }

      // Позиция курсора относительно контейнера (0..1)
      const mouseX = e.clientX - containerRect.left;
      const mouseY = e.clientY - containerRect.top;
      const posX = mouseX / containerWidth; // 0 = слева, 1 = справа
      const posY = mouseY / containerHeight; // 0 = сверху, 1 = снизу

      // Максимальное смещение (на сколько можно двигать)
      const maxOffsetX = Math.max(0, (scaledImgWidth - containerWidth) / 2);
      const maxOffsetY = Math.max(0, (scaledImgHeight - containerHeight) / 2);

      // Рассчитываем смещение: когда курсор слева — изображение уходит вправо и наоборот
      translateX = maxOffsetX - posX * (maxOffsetX * 2);
      translateY = maxOffsetY - posY * (maxOffsetY * 2);

      applyTransform();
    }

    function handleDesktopMouseLeave() {
      // На десктопе при уходе курсора с увеличенного изображения - сбрасываем зум
      if (isZoomed && !isTouchDevice()) {
        resetZoom();
      }
    }

    // === Функции масштабирования ===
    function zoomToDefault() {
      currentScale = (MIN_ZOOM + MAX_ZOOM) / 2;
      isZoomed = true;

      expandContainer();
      applyTransform();
      updateZoomIndicator();
      updateInteractionTime();

      if (window.matchMedia('(hover: hover)').matches && !isTouchDevice()) {
        enableDesktopZoomMode();
        galleryImg.classList.remove('cursor-grab', 'cursor-grabbing', 'cursor-zoom-in');
        galleryImg.classList.add('cursor-zoom-out');
      } else {
        setGrabCursor();
        // Показываем кнопку сброса зума на мобильных
        if (galleryResetZoom) {
          galleryResetZoom.classList.remove('hidden');
        }
        // Запускаем таймер автосброса
        startAutoResetTimer();
      }
    }

    function resetZoom() {
      currentScale = 1;
      translateX = 0;
      translateY = 0;
      isZoomed = false;

      resetContainer();
      applyTransform();
      updateZoomIndicator();
      updateInteractionTime();

      disableDesktopZoomMode();
      setZoomInCursor();

      // Скрываем кнопку сброса зума на мобильных
      if (galleryResetZoom) {
        galleryResetZoom.classList.add('hidden');
      }

      // Останавливаем таймер автосброса
      clearTimeout(autoResetZoomTimer);
    }

    function toggleZoom() {
      updateInteractionTime();
      if (isZoomed) {
        resetZoom();
      } else {
        zoomToDefault();
      }
    }

    function zoomIn() {
      const newScale = Math.min(currentScale + ZOOM_STEP, MAX_ZOOM);
      if (newScale !== currentScale) {
        currentScale = newScale;
        isZoomed = true;
        expandContainer();
        applyTransform();
        updateZoomIndicator();
        resetCursor();
        updateInteractionTime();
        startAutoResetTimer();
      }
    }

    function zoomOut() {
      const newScale = Math.max(currentScale - ZOOM_STEP, MIN_ZOOM);
      if (newScale !== currentScale) {
        currentScale = newScale;
        isZoomed = true;
        expandContainer();
        applyTransform();
        updateZoomIndicator();
        resetCursor();
        updateInteractionTime();
        startAutoResetTimer();
      }
    }

    function expandContainer() {
      galleryImageContainer.classList.remove('max-w-full', 'max-h-[calc(90vh-2rem)]', 'lg:max-h-[90vh]');

      if (window.innerWidth < 1024) {
        // На мобильных - уменьшаем максимальную высоту чтобы не перекрывало миниатюры
        galleryImageContainer.classList.add('max-w-[95vw]', 'max-h-[calc(85vh-2rem)]', 'overflow-auto', 'mb-8');
      } else {
        galleryImageContainer.classList.add('lg:max-w-[calc(95vw-6rem)]', 'max-w-[95vw]', 'max-h-[90vh]', 'overflow-auto');
      }

      galleryImg.classList.remove('max-w-full', 'max-h-[calc(90vh-2rem)]', 'lg:max-h-[90vh]');
      galleryImg.classList.add('max-w-none', 'max-h-none');
    }

    function resetContainer() {
      galleryImageContainer.classList.remove(
        'lg:max-w-[calc(95vw-2rem)]', 'max-w-[95vw]',
        'max-h-[calc(85vh-2rem)]', 'max-h-[90vh]',
        'overflow-auto', 'mb-20'
      );

      galleryImageContainer.classList.add('max-w-full', 'max-h-[calc(90vh-2rem)]', 'lg:max-h-[90vh]', 'mb-2', 'lg:mb-0');
      galleryImg.classList.remove('max-w-none', 'max-h-none');
      galleryImg.classList.add('max-w-full', 'max-h-[calc(90vh-2rem)]', 'lg:max-h-[90vh]');
    }

    function applyTransform() {
      galleryImg.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
    }

    function updateZoomIndicator() {
      if (galleryZoomIndicator) {
        if (isZoomed) {
          galleryZoomIndicator.textContent = Math.round(currentScale * 100) + '%';
          galleryZoomIndicator.classList.remove('hidden');
        } else {
          galleryZoomIndicator.classList.add('hidden');
        }
      }
    }

    // === Открытие/закрытие галереи ===
    mainImageContainer?.addEventListener('click', () => {
      currentGalleryIndex = currentMainIndex;
      resetZoom();
      createThumbnails(); // Создаём миниатюры при открытии
      updateGalleryImage();
      galleryModal.classList.remove('hidden', 'pointer-events-none');
      setTimeout(() => {
        galleryModal.classList.add('opacity-100', 'pointer-events-auto');
        updateInteractionTime();
      }, 10);
    });

    function closeGallery() {
      resetZoom();
      galleryModal.classList.remove('opacity-100', 'pointer-events-auto');
      setTimeout(() => galleryModal.classList.add('hidden', 'pointer-events-none'), 300);
      clearTimeout(autoResetZoomTimer);
    }

    galleryClose?.addEventListener('click', closeGallery);
    galleryModal?.addEventListener('click', (e) => {
      if (e.target === galleryModal) closeGallery();
    });

    // === Кнопка сброса зума для мобильных ===
    if (galleryResetZoom) {
      galleryResetZoom.addEventListener('click', resetZoom);
    }

    // === Навигация ===
    galleryPrev?.addEventListener('click', () => {
      resetZoom();
      currentGalleryIndex = (currentGalleryIndex - 1 + photos.length) % photos.length;
      updateGalleryImage();
      updateThumbnailSelection();
      updateInteractionTime();
    });

    galleryNext?.addEventListener('click', () => {
      resetZoom();
      currentGalleryIndex = (currentGalleryIndex + 1) % photos.length;
      updateGalleryImage();
      updateThumbnailSelection();
      updateInteractionTime();
    });

    function updateGalleryImage() {
      const photo = photos[currentGalleryIndex];
      galleryImg.src = photo.src;
      galleryImg.alt = photo.alt;
      resetZoom(); // гарантируем сброс при смене
      if (galleryCounter) {
        galleryCounter.textContent = `${currentGalleryIndex + 1} / ${photos.length}`;
      }
      updateInteractionTime();
    }

    // === Клик по изображению — переключение зума ===
    galleryImg.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleZoom();
    });

    // === Только для мобильных: drag при нажатии ===
    galleryImg.addEventListener('touchstart', (e) => {
      if (!isZoomed || e.touches.length !== 1) return;
      e.preventDefault();
      isDragging = true;
      startX = e.touches[0].clientX - translateX;
      startY = e.touches[0].clientY - translateY;
      setGrabCursor();
      document.addEventListener('touchmove', drag);
      document.addEventListener('touchend', endDrag);
      updateInteractionTime();
      startAutoResetTimer();
    });

    function drag(e) {
      if (!isDragging || !isZoomed) return;
      if (e.touches.length !== 1) return;
      e.preventDefault();
      const clientX = e.touches[0].clientX;
      const clientY = e.touches[0].clientY;
      const newTranslateX = clientX - startX;
      const newTranslateY = clientY - startY;

      const imgRect = galleryImg.getBoundingClientRect();
      const containerRect = galleryImageContainer.getBoundingClientRect();
      const maxX = Math.max(0, (imgRect.width * currentScale - containerRect.width) / 2);
      const maxY = Math.max(0, (imgRect.height * currentScale - containerRect.height) / 2);

      translateX = Math.max(-maxX, Math.min(maxX, newTranslateX));
      translateY = Math.max(-maxY, Math.min(maxY, newTranslateY));
      applyTransform();
      updateInteractionTime();
    }

    function endDrag() {
      if (!isDragging) return;
      isDragging = false;
      document.removeEventListener('touchmove', drag);
      document.removeEventListener('touchend', endDrag);
      resetCursor();
      updateInteractionTime();
      startAutoResetTimer();
    }

    // === Колесо мыши — только если не в десктоп-режиме ===
    galleryImageContainer.addEventListener('wheel', (e) => {
      if (!isZoomed || isTouchDevice()) return;
      e.preventDefault();
      if (e.deltaY < 0) zoomIn();
      else zoomOut();
      updateInteractionTime();
    }, { passive: false });

    // === Жесты (масштабирование) на мобильных ===
    let initialDistance = 0;
    let initialScale = 1;

    galleryImageContainer.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        initialDistance = getDistance(e.touches[0], e.touches[1]);
        initialScale = currentScale;
        updateInteractionTime();
      }
    });

    galleryImageContainer.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const currentDistance = getDistance(e.touches[0], e.touches[1]);
        const scaleFactor = currentDistance / initialDistance;
        const newScale = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, initialScale * scaleFactor));
        if (newScale !== currentScale) {
          currentScale = newScale;
          isZoomed = true;
          expandContainer();
          applyTransform();
          updateZoomIndicator();
          setGrabCursor();
          updateInteractionTime();
          startAutoResetTimer();
        }
      }
    });

    function getDistance(touch1, touch2) {
      const dx = touch1.clientX - touch2.clientX;
      const dy = touch1.clientY - touch2.clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }

    // === Клавиатура ===
    window.addEventListener('keydown', (e) => {
      if (!galleryModal.classList.contains('opacity-100')) return;
      if (e.key === 'Escape') {
        if (isZoomed) resetZoom();
        else closeGallery();
      } else if (e.key === 'ArrowLeft') galleryPrev?.click();
      else if (e.key === 'ArrowRight') galleryNext?.click();
      else if (e.key === 'ArrowUp') {
        changeGalleryImage(Math.max(0, currentGalleryIndex - 1));
      } else if (e.key === 'ArrowDown') {
        changeGalleryImage(Math.min(photos.length - 1, currentGalleryIndex + 1));
      } else if (e.key === '0') resetZoom();
      else if (e.key === '1') zoomToDefault();
      else if (e.key === '+' || e.key === '=') zoomIn();
      else if (e.key === '-' || e.key === '_') zoomOut();
      updateInteractionTime();
    });

    // === Смена основного изображения (миниатюры) ===
    const infoDots = document.getElementById('infoDots');

    function changeMainImage(thumb) {
      const bigImage = thumb.dataset.bigimage;
      const alt = thumb.alt;
      const index = parseInt(thumb.dataset.index, 10);

      if (!mainImage || !bigImage || isNaN(index)) return;

      // Обновляем подсветку
      document.querySelectorAll('.slider-track img').forEach(img => {
        img.style.borderColor = '';
      });
      thumb.style.setProperty('border-color', '#2563eb', 'important');

      // Обновляем индекс
      currentMainIndex = index;

      // Обновляем точки (если нужно)
      if (infoDots) {
        infoDots.classList.toggle('hidden', index !== 0);
      }

      // Загружаем изображение
      const tempImg = new Image();
      tempImg.onload = () => {
        mainImage.src = bigImage; // только после успешной загрузки
        mainImage.alt = alt;
        requestAnimationFrame(refreshSlider);
      };
      tempImg.onerror = () => {
        mainImage.src = bigImage;
        mainImage.alt = alt;
        requestAnimationFrame(refreshSlider);
      };
      tempImg.src = bigImage; // запуск загрузки
    }

    // Инициализация миниатюр
    const firstThumb = document.querySelector('.slider-track img');
    if (firstThumb) {
      currentMainIndex = parseInt(firstThumb.dataset.index, 10) || 0;
      changeMainImage(firstThumb);
    }

    document.querySelectorAll('.slider-track img').forEach(img => {
      img.addEventListener('click', () => changeMainImage(img));
    });

    // === Адаптивность слайдера миниатюр (оставляем вашу логику) ===
    function updateThumbnailSliderHeight() {
      const track = document.querySelector('.slider-track');
      const container = document.querySelector(".slider-thumbnails-container > .relative");

      // Если элементов нет — выходим
      if (!track || !container) return;

      if (window.innerWidth < 1024) {
        // === Мобильный режим: сбрасываем ВСЁ (ширина по содержимому или 100%) ===
        track.style.height = '';
        track.style.maxHeight = '';
        track.style.width = '';
        track.style.minWidth = '';
        track.style.maxWidth = '';

        container.style.height = '';
        container.style.maxHeight = '';
        container.style.width = '';
        container.style.minWidth = '';
        container.style.maxWidth = '';

        return;
      }

      // === Десктопный режим (>=1024px) ===
      const mainImageEl = document.querySelector('#mainImageContainer > img');
      if (!mainImageEl) return;

      const imageHeight = mainImageEl.getBoundingClientRect().height;
      if (imageHeight <= 0) return;

      const btnHeight = 20; // высота кнопок "вверх/вниз"
      const gap = 16;       // суммарный gap между кнопками и треком
      const desiredTrackHeight = imageHeight - btnHeight * 2 - gap;
      const finalTrackHeight = desiredTrackHeight > 100 ? desiredTrackHeight : 400;

      // --- Устанавливаем стили для КОНТЕЙНЕРА (обёртка с кнопками) ---
      container.style.height = imageHeight + 'px';
      container.style.maxHeight = imageHeight + 'px';
      container.style.width = '80px';
      container.style.minWidth = '80px';
      container.style.maxWidth = '80px';
    }

    function refreshSlider() {
      updateThumbnailSliderHeight();
    }

    // === Обработка ресайза окна ===
    function handleResize() {
      refreshSlider();
      // При ресайзе сбрасываем зум для корректного отображения
      if (isZoomed) {
        resetZoom();
      }
    }

    window.addEventListener('load', refreshSlider);
    window.addEventListener('resize', handleResize);
    mainImage?.addEventListener('load', refreshSlider);

    // Инициализация
    setZoomInCursor();
  });
</script>
