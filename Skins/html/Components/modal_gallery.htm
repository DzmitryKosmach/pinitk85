<!-- Модальное окно галереи -->
<div
  id="gallery-modal"
  class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300 hidden"
>
  <!-- Центральное изображение -->
  <div
    id="gallery-image-container"
    class="relative flex items-center justify-center rounded-xl overflow-hidden transition-all duration-300 ease-out"
  >
    <img
      id="gallery-main-img"
      src=""
      alt=""
      class="max-w-full max-h-[90vh] object-contain shadow-2xl transition-transform duration-300 ease-out cursor-zoom-in"
    />
  </div>

  <!-- Кнопка закрытия -->
  <button
    id="gallery-close"
    class="absolute top-4 right-4 text-white/90 hover:text-white text-lg font-light z-51 bg-black/40 backdrop-blur-sm rounded-full w-10 h-10 flex items-center justify-center transition-all duration-200 ease-in-out hover:bg-black/60"
    aria-label="Закрыть галерею"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>

  <!-- Стрелка "назад" -->
  <button
    id="gallery-prev"
    class="absolute left-4 top-1/2 -translate-y-1/2 z-51 p-3 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-sm text-white transition-all duration-200 ease-in-out hover:scale-105 focus:outline-none focus:ring-2 focus:ring-white/40"
    aria-label="Предыдущее изображение"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
    </svg>
  </button>

  <!-- Стрелка "вперёд" -->
  <button
    id="gallery-next"
    class="absolute right-4 top-1/2 -translate-y-1/2 z-51 p-3 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-sm text-white transition-all duration-200 ease-in-out hover:scale-105 focus:outline-none focus:ring-2 focus:ring-white/40"
    aria-label="Следующее изображение"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
    </svg>
  </button>

  <!-- Счётчик -->
  <div
    id="gallery-counter"
    class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white/80 text-sm font-mono tracking-wide bg-black/30 px-3 py-1.5 rounded-full backdrop-blur-sm"
  ></div>

  <!-- Индикатор масштаба -->
  <div
    id="gallery-zoom-indicator"
    class="absolute top-4 left-4 text-white/80 text-sm font-mono tracking-wide bg-black/30 px-3 py-1.5 rounded-full backdrop-blur-sm hidden"
  >
    100%
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // === ГАЛЕРЕЯ: данные ===
    const photos = <?php echo json_encode(array_map(function($p) use ($catInf, $seriesInf) {
      return [
        'src' => Catalog::photoUrl(Catalog_Series_Photos::$imagePath, $p['id'], 0, 0, 0, $p['_img_ext'], [$catInf['url'], $seriesInf['url']]),
        'thumb' => Catalog::photoUrl(Catalog_Series_Photos::$imagePath, $p['id'], 90, 90, $p['rm'], $p['_img_ext']),
        'alt' => hsch(trim($p['alt']) ? $p['alt'] : $catInf['name'] . ' ' . $seriesInf['name'])
    ];
    }, $photos)); ?>;

    let currentGalleryIndex = 0;
    let isZoomed = false;
    let isDragging = false; // только для мобильных
    let startX, startY;
    let translateX = 0, translateY = 0;
    let currentScale = 1;
    let isDesktopZoomMode = false;

    // === НАСТРОЙКИ МАСШТАБИРОВАНИЯ ===
    const MIN_ZOOM = 1.2;
    const MAX_ZOOM = 2.4;
    const ZOOM_STEP = 0.1;

    // === Элементы DOM ===
    const mainImage = document.getElementById('main-product-image');
    const mainImageContainer = document.getElementById('mainImageContainer');
    const galleryModal = document.getElementById('gallery-modal');
    const galleryImg = document.getElementById('gallery-main-img');
    const galleryImageContainer = document.getElementById('gallery-image-container');
    const galleryClose = document.getElementById('gallery-close');
    const galleryPrev = document.getElementById('gallery-prev');
    const galleryNext = document.getElementById('gallery-next');
    const galleryCounter = document.getElementById('gallery-counter');
    const galleryZoomIndicator = document.getElementById('gallery-zoom-indicator');

    // === Функции управления курсором ===
    function setZoomInCursor() {
      galleryImg.classList.remove('cursor-grab', 'cursor-grabbing', 'cursor-zoom-out');
      galleryImg.classList.add('cursor-zoom-in');
    }

    function setGrabCursor() {
      galleryImg.classList.remove('cursor-zoom-in', 'cursor-grabbing', 'cursor-zoom-out');
      galleryImg.classList.add('cursor-grab');
    }

    function resetCursor() {
      if (isZoomed) {
        if (window.matchMedia('(hover: hover)').matches && !isTouchDevice()) {
          galleryImg.classList.remove('cursor-grab', 'cursor-grabbing', 'cursor-zoom-in');
          galleryImg.classList.add('cursor-zoom-out');
        } else {
          setGrabCursor();
        }
      } else {
        setZoomInCursor();
      }
    }

    function isTouchDevice() {
      return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    }

    // === Управление десктопным режимом (перемещение за курсором) ===
    function enableDesktopZoomMode() {
      if (isDesktopZoomMode) return;
      isDesktopZoomMode = true;
      galleryImageContainer.addEventListener('mousemove', handleDesktopPan);
    }

    function disableDesktopZoomMode() {
      if (!isDesktopZoomMode) return;
      isDesktopZoomMode = false;
      galleryImageContainer.removeEventListener('mousemove', handleDesktopPan);
    }

    function handleDesktopPan(e) {
      if (!isZoomed || isTouchDevice()) return;

      const containerRect = galleryImageContainer.getBoundingClientRect();
      const imgRect = galleryImg.getBoundingClientRect();

      // Размеры видимой области и полного масштабированного изображения
      const containerWidth = containerRect.width;
      const containerHeight = containerRect.height;
      const scaledImgWidth = imgRect.width * currentScale;
      const scaledImgHeight = imgRect.height * currentScale;

      // Если изображение не выходит за границы — ничего не двигаем
      if (scaledImgWidth <= containerWidth && scaledImgHeight <= containerHeight) {
        translateX = 0;
        translateY = 0;
        applyTransform();
        return;
      }

      // Позиция курсора относительно контейнера (0..1)
      const mouseX = e.clientX - containerRect.left;
      const mouseY = e.clientY - containerRect.top;
      const posX = mouseX / containerWidth; // 0 = слева, 1 = справа
      const posY = mouseY / containerHeight; // 0 = сверху, 1 = снизу

      // Максимальное смещение (на сколько можно двигать)
      const maxOffsetX = Math.max(0, (scaledImgWidth - containerWidth) / 2);
      const maxOffsetY = Math.max(0, (scaledImgHeight - containerHeight) / 2);

      // Рассчитываем смещение: когда курсор слева — изображение уходит вправо и наоборот
      translateX = maxOffsetX - posX * (maxOffsetX * 2);
      translateY = maxOffsetY - posY * (maxOffsetY * 2);

      applyTransform();
    }

    // === Функции масштабирования ===
    function zoomToDefault() {
      currentScale = (MIN_ZOOM + MAX_ZOOM) / 2;
      isZoomed = true;

      expandContainer();
      applyTransform();
      updateZoomIndicator();

      if (window.matchMedia('(hover: hover)').matches && !isTouchDevice()) {
        enableDesktopZoomMode();
        galleryImg.classList.remove('cursor-grab', 'cursor-grabbing', 'cursor-zoom-in');
        galleryImg.classList.add('cursor-zoom-out');
      } else {
        setGrabCursor();
      }
    }

    function resetZoom() {
      currentScale = 1;
      translateX = 0;
      translateY = 0;
      isZoomed = false;

      resetContainer();
      applyTransform();
      updateZoomIndicator();

      disableDesktopZoomMode();
      setZoomInCursor();
    }

    function toggleZoom() {
      if (isZoomed) {
        resetZoom();
      } else {
        zoomToDefault();
      }
    }

    function zoomIn() {
      const newScale = Math.min(currentScale + ZOOM_STEP, MAX_ZOOM);
      if (newScale !== currentScale) {
        currentScale = newScale;
        isZoomed = true;
        expandContainer();
        applyTransform();
        updateZoomIndicator();
        resetCursor();
      }
    }

    function zoomOut() {
      const newScale = Math.max(currentScale - ZOOM_STEP, MIN_ZOOM);
      if (newScale !== currentScale) {
        currentScale = newScale;
        isZoomed = true;
        expandContainer();
        applyTransform();
        updateZoomIndicator();
        resetCursor();
      }
    }

    function expandContainer() {
      galleryImageContainer.classList.remove('max-w-full', 'max-h-[90vh]');
      galleryImageContainer.classList.add('max-w-[95vw]', 'max-h-[95vh]', 'overflow-auto');
      galleryImg.classList.remove('max-w-full', 'max-h-[90vh]');
      galleryImg.classList.add('max-w-none', 'max-h-none');
    }

    function resetContainer() {
      galleryImageContainer.classList.remove('max-w-[95vw]', 'max-h-[95vh]', 'overflow-auto');
      galleryImageContainer.classList.add('max-w-full', 'max-h-[90vh]');
      galleryImg.classList.remove('max-w-none', 'max-h-none');
      galleryImg.classList.add('max-w-full', 'max-h-[90vh]');
    }

    function applyTransform() {
      galleryImg.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
    }

    function updateZoomIndicator() {
      if (galleryZoomIndicator) {
        if (isZoomed) {
          galleryZoomIndicator.textContent = Math.round(currentScale * 100) + '%';
          galleryZoomIndicator.classList.remove('hidden');
        } else {
          galleryZoomIndicator.classList.add('hidden');
        }
      }
    }

    // === Открытие/закрытие галереи ===
    mainImageContainer?.addEventListener('click', () => {
      currentGalleryIndex = 0;
      resetZoom();
      updateGalleryImage();
      galleryModal.classList.remove('hidden', 'pointer-events-none');
      setTimeout(() => galleryModal.classList.add('opacity-100', 'pointer-events-auto'), 10);
    });

    function closeGallery() {
      resetZoom();
      galleryModal.classList.remove('opacity-100', 'pointer-events-auto');
      setTimeout(() => galleryModal.classList.add('hidden', 'pointer-events-none'), 300);
    }

    galleryClose?.addEventListener('click', closeGallery);
    galleryModal?.addEventListener('click', (e) => {
      if (e.target === galleryModal) closeGallery();
    });

    // === Навигация ===
    galleryPrev?.addEventListener('click', () => {
      resetZoom();
      currentGalleryIndex = (currentGalleryIndex - 1 + photos.length) % photos.length;
      updateGalleryImage();
    });

    galleryNext?.addEventListener('click', () => {
      resetZoom();
      currentGalleryIndex = (currentGalleryIndex + 1) % photos.length;
      updateGalleryImage();
    });

    function updateGalleryImage() {
      const photo = photos[currentGalleryIndex];
      galleryImg.src = photo.src;
      galleryImg.alt = photo.alt;
      resetZoom(); // гарантируем сброс при смене
      if (galleryCounter) {
        galleryCounter.textContent = `${currentGalleryIndex + 1} / ${photos.length}`;
      }
    }

    // === Клик по изображению — переключение зума ===
    galleryImg.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleZoom();
    });

    // === Только для мобильных: drag при нажатии ===
    galleryImg.addEventListener('touchstart', (e) => {
      if (!isZoomed || e.touches.length !== 1) return;
      e.preventDefault();
      isDragging = true;
      startX = e.touches[0].clientX - translateX;
      startY = e.touches[0].clientY - translateY;
      setGrabCursor(); // временно
      document.addEventListener('touchmove', drag);
      document.addEventListener('touchend', endDrag);
    });

    function drag(e) {
      if (!isDragging || !isZoomed) return;
      if (e.touches.length !== 1) return;
      e.preventDefault();
      const clientX = e.touches[0].clientX;
      const clientY = e.touches[0].clientY;
      const newTranslateX = clientX - startX;
      const newTranslateY = clientY - startY;

      const imgRect = galleryImg.getBoundingClientRect();
      const containerRect = galleryImageContainer.getBoundingClientRect();
      const maxX = Math.max(0, (imgRect.width * currentScale - containerRect.width) / 2);
      const maxY = Math.max(0, (imgRect.height * currentScale - containerRect.height) / 2);

      translateX = Math.max(-maxX, Math.min(maxX, newTranslateX));
      translateY = Math.max(-maxY, Math.min(maxY, newTranslateY));
      applyTransform();
    }

    function endDrag() {
      if (!isDragging) return;
      isDragging = false;
      document.removeEventListener('touchmove', drag);
      document.removeEventListener('touchend', endDrag);
      resetCursor(); // вернёт grab (на мобилках)
    }

    // === Колесо мыши — только если не в десктоп-режиме ===
    galleryImageContainer.addEventListener('wheel', (e) => {
      if (!isZoomed || isTouchDevice()) return;
      e.preventDefault();
      if (e.deltaY < 0) zoomIn();
      else zoomOut();
    }, { passive: false });

    // === Жесты (масштабирование) на мобильных ===
    let initialDistance = 0;
    let initialScale = 1;

    galleryImageContainer.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        initialDistance = getDistance(e.touches[0], e.touches[1]);
        initialScale = currentScale;
      }
    });

    galleryImageContainer.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const currentDistance = getDistance(e.touches[0], e.touches[1]);
        const scaleFactor = currentDistance / initialDistance;
        const newScale = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, initialScale * scaleFactor));
        if (newScale !== currentScale) {
          currentScale = newScale;
          isZoomed = true;
          expandContainer();
          applyTransform();
          updateZoomIndicator();
          setGrabCursor();
        }
      }
    });

    function getDistance(touch1, touch2) {
      const dx = touch1.clientX - touch2.clientX;
      const dy = touch1.clientY - touch2.clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }

    // === Клавиатура ===
    window.addEventListener('keydown', (e) => {
      if (!galleryModal.classList.contains('opacity-100')) return;
      if (e.key === 'Escape') {
        if (isZoomed) resetZoom();
        else closeGallery();
      } else if (e.key === 'ArrowLeft') galleryPrev?.click();
      else if (e.key === 'ArrowRight') galleryNext?.click();
      else if (e.key === '0') resetZoom();
      else if (e.key === '1') zoomToDefault();
      else if (e.key === '+' || e.key === '=') zoomIn();
      else if (e.key === '-' || e.key === '_') zoomOut();
    });

    // Инициализация
    setZoomInCursor();
  });
</script>
