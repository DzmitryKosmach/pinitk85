<?php echo CssCopmress::load('catalog')?>
<?php echo JsCopmress::load('catalog')?>
<?php echo JsCopmress::load('compare')?>

<?php echo CssCopmress::load('category')?>
<?php echo JsCopmress::load('category')?>

<script>
  oCompare.url = '<?php echo Url::a('catalog-compare'); ?>';
</script>

<div>
  <div>
    <!-- Хлебные крошки -->
    <nav
      class="text-sm text-gray-500 flex flex-wrap items-center gap-1 mb-4 "
    >
      <?php if(count($breadcrumbs)) { ?>
      <?php $bcLast = array_pop($breadcrumbs); ?>
      <?php $position = 0; ?>
      <?php foreach($breadcrumbs as $bc) { ?>
      <?php $position = $position + 1; ?>
      <a href="<?php echo $bc['url']; ?>" class="hover:text-gray-700">
        <?php echo $bc['name']; ?>
      </a>
      <span class="mx-1">›</span>
      <?php } ?>
      <span class="text-gray-700">
        <?php echo $bcLast['name']; ?>
      </span>
      <?php } ?>
    </nav>

    <section class="">
      <div>
        <h1 class="text-xl md:text-2xl font-bold mb-2 ">
          <?php echo $pageInf['header']; ?>
        </h1>

        <?php if (!empty($pages)): ?>
        <!-- Табы -->
        <div
          class="sticky top-[54px] sm3:top-[32px] lg:top-[36px] pt-2 z-20 bg-body"
        >
          <div class="text-[11px] sm3:text-sm lg:text-base mb-4 lg:mb-8">
            <!-- Контейнер для всех табов (скрытый) -->
            <div id="allTabsContainer" class="hidden">
              <?php foreach ($pages as $p): ?>
              <?php $isActive = ($_SERVER['REQUEST_URI'] === Catalog_Pages::a($p['id'])); ?>
              <?php if ($isActive): ?>
              <a href="<?php echo $bc['url']; ?>"
                 class="all-tab-item flex-1 min-h-8 px-1 md:px-4 lg:min-h-10 lg:px-6 leading-3 font-medium rounded-xl bg-blue-600 text-white border border-blue-600 shadow text-center flex items-center justify-center"
                 data-tab-name="<?php echo htmlspecialchars($p['name'], ENT_QUOTES, 'UTF-8'); ?>"
                 data-tab-href="<?php echo $bc['url']; ?>"
                 data-is-active="true"
              >
                <?php echo htmlspecialchars($p['name']); ?>
              </a>

              <?php else: ?>
              <a
                href="<?php echo Catalog_Pages::a($p['id']); ?>"
                class="all-tab-item flex-1 min-h-8 px-1 md:px-4 lg:min-h-10 lg:px-6 leading-3 rounded-xl bg-white border border-gray-300 shadow text-center flex items-center justify-center text-gray-800 hover:bg-gray-50 transition"
                data-tab-name="<?php echo htmlspecialchars($p['name'], ENT_QUOTES, 'UTF-8'); ?>"
                data-tab-href="<?php echo Catalog_Pages::a($p['id']); ?>"
                data-is-active="false"
              >
                <?php echo htmlspecialchars($p['name']); ?>
              </a>
              <?php endif; ?>
              <?php endforeach; ?>
            </div>

            <!-- Основной ряд: видимые табы + кнопка "Ещё/Свернуть" -->
            <div id="visibleTabsRow" class="flex flex-wrap items-center gap-1 sm:gap-2">
              <!-- Табы и кнопка "Ещё/Свернуть" будут вставлены сюда JS -->
            </div>

            <!-- Скрытые табы (изначально скрыты) -->
            <div
              id="hiddenWrapper"
              class="overflow-hidden max-h-0 opacity-0 transition-all duration-500 ease-in-out mt-2"
            >
              <div id="hiddenTabsContainer" class="flex flex-wrap gap-1 sm:gap-2 pb-2">
                <!-- Скрытые табы будут вставлены сюда JS -->
              </div>
            </div>
          </div>
        </div>

        <style>
          /* Анимация "пульс" для кнопки */
          @keyframes pulseAttention {
            0%,
            100% {
              transform: scale(1);
            }
            50% {
              transform: scale(1.08);
            }
          }
          .attention {
            animation: pulseAttention 1.5s infinite;
          }
        </style>

        <script>
          document.addEventListener("DOMContentLoaded", () => {
            // --- Конфигурация ---
            const MIN_VISIBLE_TABS = 1; // Минимальное количество видимых табов
            const TAB_GAP = 8; // Приблизительный зазор между табами в px (gap-1 ~ 4px, gap-2 ~ 8px на sm+)
            const SHOW_MORE_BTN_WIDTH = 60; // Приблизительная ширина кнопки "Ещё" в px

            // --- DOM элементы ---
            const allTabsContainer = document.getElementById('allTabsContainer');
            const visibleTabsRow = document.getElementById('visibleTabsRow');
            const hiddenTabsContainer = document.getElementById('hiddenTabsContainer');
            const hiddenWrapper = document.getElementById("hiddenWrapper");

            if (!allTabsContainer || !visibleTabsRow || !hiddenTabsContainer || !hiddenWrapper) {
              console.error("Не найдены необходимые DOM элементы для управления табами.");
              return;
            }

            // --- Хранилище данных ---
            let allTabsData = []; // [{name, href, isActive, element}, ...]
            let isExpanded = localStorage.getItem("tabsExpanded") === "true";
            let currentVisibleCount = MIN_VISIBLE_TABS; // Начальное значение

            // --- Функции ---

            // Создание кнопки "Ещё/Свернуть"
            function createShowMoreButton() {
              const buttonContainer = document.createElement('div');
              buttonContainer.innerHTML = `
        <button
          id="showMoreBtn"
          class="flex align-middle text-white min-h-8 px-1 text-[11px] sm3:text-sm md:px-2 lg:min-h-10 lg:px-3 rounded-xl shadow flex items-center justify-center gap-1 transition whitespace-nowrap"
        >
          <span id="btnText">Ещё</span>
          <svg
            id="btnIcon"
            class="w-4 h-4 transition-transform duration-300"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </button>
      `;
              return buttonContainer.firstElementChild;
            }

            // Инициализация данных табов из DOM
            function initializeTabsData() {
              const allTabElements = allTabsContainer.querySelectorAll('.all-tab-item');
              allTabsData = Array.from(allTabElements).map(el => ({
                name: el.getAttribute('data-tab-name'),
                href: el.getAttribute('data-tab-href'),
                isActive: el.getAttribute('data-is-active') === 'true',
                element: el // Сохраняем оригинальный элемент
              }));
            }

            // Расчет максимального количества табов, помещающихся в видимый ряд
            function calculateVisibleTabsCount() {
              const containerWidth = visibleTabsRow.offsetWidth;
              if (containerWidth <= 0) return MIN_VISIBLE_TABS;

              // измеряем ВСЕ табы
              const widths = allTabsData.map(t => {
                const clone = t.element.cloneNode(true);
                clone.style.visibility = 'hidden';
                clone.style.position = 'absolute';
                clone.classList.remove('flex-1');
                document.body.appendChild(clone);
                const w = clone.offsetWidth;
                document.body.removeChild(clone);
                return w;
              });

              let used = SHOW_MORE_BTN_WIDTH; // сразу учитываем кнопку
              let count = 0;

              for (let w of widths) {
                if (used + w > containerWidth) break;
                used += w + TAB_GAP;
                count++;
              }

              --count;

              return Math.max(MIN_VISIBLE_TABS, count);
            }


            // Обновление отображения табов на основе currentVisibleCount и isExpanded
            function updateTabsDisplay() {
              visibleTabsRow.innerHTML = ''; // Очищаем видимый ряд
              hiddenTabsContainer.innerHTML = ''; // Очищаем скрытый контейнер

              const totalTabs = allTabsData.length;

              if (totalTabs === 0) {
                // Если нет табов, просто убедимся, что кнопка скрыта
                const existingBtn = visibleTabsRow.querySelector('#showMoreBtn');
                if (existingBtn) {
                  existingBtn.remove();
                }
                hiddenWrapper.classList.add("max-h-0", "opacity-0");
                hiddenWrapper.classList.remove("max-h-[1000px]", "opacity-100");
                return;
              }

              const visibleCount = Math.min(currentVisibleCount, totalTabs);
              const needsMoreButton = totalTabs > visibleCount;

              // Заполняем видимый ряд табами
              for (let i = 0; i < visibleCount; i++) {
                const tabData = allTabsData[i];
                const clone = tabData.element.cloneNode(true); // Клонируем элемент
                visibleTabsRow.appendChild(clone);
              }

              // Создаем и добавляем кнопку "Ещё/Свернуть" в видимый ряд, если нужно
              if (needsMoreButton) {
                const showMoreBtn = createShowMoreButton();
                visibleTabsRow.appendChild(showMoreBtn);

                // Управляем состоянием кнопки и скрытого блока
                if (isExpanded) {
                  hiddenWrapper.classList.remove("max-h-0", "opacity-0");
                  hiddenWrapper.classList.add("max-h-[1000px]", "opacity-100"); // max-h-[1000px] или другое значение
                  document.getElementById("btnText").textContent = "Скрыть";
                  showMoreBtn.classList.remove("bg-blue-600", "hover:bg-blue-700", "attention");
                  showMoreBtn.classList.add("bg-gray-600", "hover:bg-gray-700");
                  document.getElementById("btnIcon").classList.add("rotate-180");
                } else {
                  hiddenWrapper.classList.add("max-h-0", "opacity-0");
                  hiddenWrapper.classList.remove("max-h-[1000px]", "opacity-100");
                  document.getElementById("btnText").textContent = "Ещё";
                  showMoreBtn.classList.remove("bg-gray-600", "hover:bg-gray-700");
                  showMoreBtn.classList.add("bg-blue-600", "hover:bg-blue-700", "attention");
                  document.getElementById("btnIcon").classList.remove("rotate-180");
                }

                // Добавляем обработчик клика к новой кнопке
                showMoreBtn.addEventListener("click", () => {
                  isExpanded = !isExpanded; // Переключаем состояние
                  updateTabsDisplay(); // Обновляем отображение
                  localStorage.setItem("tabsExpanded", isExpanded.toString()); // Сохраняем состояние
                });

              } else {
                // Если кнопка не нужна, убедимся, что она удалена из видимого ряда
                const existingBtn = visibleTabsRow.querySelector('#showMoreBtn');
                if (existingBtn) {
                  existingBtn.remove();
                }
                // Убедимся, что скрытый блок скрыт, если кнопка не нужна
                hiddenWrapper.classList.add("max-h-0", "opacity-0");
                hiddenWrapper.classList.remove("max-h-[1000px]", "opacity-100");
              }

              // Заполняем скрытый контейнер оставшимися табами
              for (let i = visibleCount; i < totalTabs; i++) {
                const tabData = allTabsData[i];
                const clone = tabData.element.cloneNode(true); // Клонируем элемент
                hiddenTabsContainer.appendChild(clone);
              }
            }

            // Обработчик изменения размера окна
            function handleResize() {
              // Используем setTimeout, чтобы дать браузеру время обновить размеры элементов
              setTimeout(() => {
                const newVisibleCount = calculateVisibleTabsCount();
                if (newVisibleCount !== currentVisibleCount) {
                  currentVisibleCount = newVisibleCount;
                  updateTabsDisplay();
                }
              }, 10); // Небольшая задержка для стабильности
            }

            // --- Инициализация ---
            initializeTabsData();
            // Восстановливаем состояние из localStorage
            if (isExpanded && allTabsData.length > currentVisibleCount) {
              // Если сохранено состояние "развернуто", и есть табы для скрытия
              // оставляем isExpanded = true, но пересчитаем количество видимых табов при первом рендере
            }
            updateTabsDisplay(); // Первичный рендер
            handleResize(); // Рассчитать начальное количество табов после отображения

            // --- Слушатели событий ---
            window.addEventListener('resize', handleResize);

          });
        </script>

        <?php endif; ?>

        <div class="grid grid-cols-2 sm2:grid-cols-4 gap-2 lg:gap-6">
          <?php if($pageWithSeries) { ?>
          <?php if(count($series)) { ?>
          <?php foreach($series as $sn =>
          $s) { ?>
          <?php include(_ROOT . Catalog_Series::$tpl)?>
          <?php } ?>
          <?php } else { ?>
          <?php echo Pages::msgErr('По вашему запросу серии мебели не найдены.')?>
          <?php } ?>
          <?php } else { ?>
          <?php if(count($items)) { ?>
          <?php echo CssCopmress::load('series')?>
          <?php echo JsCopmress::load('series')?>

          <script>
            oMaterials.tree = AJAX.jsonDecode('<?php echo str_replace('\'', '\\\'', toJson($materials)) ?> ');
          </script>
          <?php foreach($items as $in =>
          $i) { ?>
          <?php
                                    $seriesInf = array(
                                        'id'            =>
          $i['series_id'], 'category_id' => $i['category_id'], 'url' =>
          $i['s_url'] ); ?>
          <?php include(Config::path('skins') . '/html/Components/items_card.htm'); ?>
          <?php } ?>

          <?php } else { ?>
          <?php echo Pages::msgErr('По вашему запросу товары не найдены.')?>
          <?php } ?>
          <?php } ?>
        </div>

        <div class="flex w-full justify-center items-center flex-col mt-8">
          <?php echo $toggle; ?>
        </div>
      </div>
    </section>

    <section>
      <!-- Наши преимущества -->
      <h2 class="text-xl xl:text-2xl font-bold mt-16 mb-8">
        Наши преимущества
      </h2>

      <div
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 justify-between text-sm md:text-base font-medium"
      >
        <div class="flex items-start gap-2 bg-white p-3 shadow rounded">
          <div
            class="shadow-[inset_0px_0px_10px_4px_rgba(43,72,241,0.20)] p-3 rounded-md shrink-0"
          >
            <img
              src="/images/category/sofa.png"
              class="w-3 h-4 lg:w-5 lg:h-6 md:w-4 md:h-5"
              alt=""
            />
          </div>
          <p class="text-base xl:text-lg font-medium">
            Эксклюзивный дизайн:
            <span class="block text-sm xl:text-lg font-normal"
            >Наши дизайнерские коллекции мебели для кабинета руководителя
              эконом класса представлены в стильном сером, лофт и других
              современных оттенках. Создайте стильное рабочее
              пространство.</span
            >
          </p>
        </div>
        <div class="flex items-start gap-2 bg-white p-3 shadow rounded">
          <div
            class="shadow-[inset_0px_0px_10px_4px_rgba(43,72,241,0.20)] p-3 rounded-md shrink-0"
          >
            <img
              src="/images/category/ruler.png"
              class="w-4 h-4 lg:w-6 lg:h-6 md:w-5 md:h-5"
              alt=""
            />
          </div>
          <p class="text-base xl:text-lg font-medium">
            Функциональные решения:
            <span class="block text-sm xl:text-lg font-normal"
            >Компьютерные столы, перегородки, металлические сейфы и
              эргономичные вешалки – наши мебельные решения предлагают высший
              уровень функциональности.</span
            >
          </p>
        </div>
        <div class="flex items-start gap-2 bg-white p-3 shadow rounded">
          <div
            class="shadow-[inset_0px_0px_10px_4px_rgba(43,72,241,0.20)] p-3 rounded-md shrink-0"
          >
            <img
              src="/images/category/shelves.png"
              class="w-4 h-4 lg:w-6 lg:h-6 md:w-5 md:h-5"
              alt=""
            />
          </div>
          <p class="text-base xl:text-lg font-medium">
            Мобильные и модульные системы: 
            <span class="block text-sm xl:text-lg font-normal"
            >Модульные стеллажи, перегородки и мобильные секции обеспечивают
              гибкость в создании уникального офисного пространства.</span
            >
          </p>
        </div>
        <div class="flex items-start gap-2 bg-white p-3 shadow rounded">
          <div
            class="shadow-[inset_0px_0px_10px_4px_rgba(43,72,241,0.20)] p-3 rounded-md shrink-0"
          >
            <img
              src="/images/category/time.png"
              class="w-4 h-4 lg:w-6 lg:h-6 md:w-5 md:h-5"
              alt=""
            />
          </div>
          <p class="text-base xl:text-lg font-medium">
            Долгий срок службы:
            <span class="block text-sm xl:text-lg font-normal"
            >Использование массива дерева и металла гарантирует долгий срок
              службы мебели. Гарантия качества подтверждена отзывами наших
              клиентов.</span
            >
          </p>
        </div>
      </div>
    </section>

    <section class="mt-16">
      <!-- Двухколоночное размещение -->
      <div class="flex flex-col md:flex-row gap-20 lg:gap-32">
        <!-- Левая колонка -->
        <div class="w-full md:w-1/2 text-sm sm:text-[16px]">
          <h2 class="text-2xl font-bold mb-2">
            Офисная мебель руководителя - ассортимент
          </h2>
          <p class="mb-4">
            В отличие от рабочего места рядового офисного сотрудника, место,
            занимаемое руководителем, должно обладать более широкой
            функциональностью. Это не только рабочая зона, но и переговорная,
            где проводятся совещания, встречи с партнерами. Кроме того,
            немаловажную роль играет интерьер офиса. В нем должен отражаться
            фирменный стиль компании, максимальный комфорт, акцент на статусе
            владельца, сфере бизнеса. У нас представлена вся необходимая мебель
            для кабинета руководителя - классический стиль, модерн или хай тек –
            огромный выбор по умеренным ценам. Коллекция каталога разбита на
            следующие сегменты:
          </p>

          <!-- Список сегментов -->
          <ul class="list-disc pl-5 mb-4 text-sm sm:text-[16px]">
            <li>
              <span class="underline">Эконом.</span> Категория меблировки,
              которая позволяет экономно обставить кабинет руководителя;
            </li>
            <li>
              <span class="underline">Бизнес.</span> Здесь представлена мебель в
              кабинете руководителя с максимальной функциональностью, богатым
              разнообразием конфигураций;
            </li>
            <li>
              <span class="underline">Премиум.</span> Данный сегмент – это
              эксклюзивный стиль, уникальные дизайнерские решения, материалы
              экстра-класса.
            </li>
            <li>
              <span class="underline">Президент комплекты.</span> Люксовая серия
              кабинетов, предназначенная для высших чинов, глав компаний,
              президентов стран.
            </li>
          </ul>

          <!-- Многообразие комплектаций -->
          <p class="mb-4">
            Многообразие комплектаций мебели кабинетов руководителя:
          </p>
          <ul class="list-disc pl-5 mb-4 text-sm sm:text-[16px]">
            <li>
              письменные, компьютерные, рабочие столы различных форм,
              дизайнерских исполнений, цветовых решений;
            </li>
            <li>брифинг-приставки различных конфигураций;</li>
            <li>
              приставки подкатные – конструкции, которые отличаются не только
              функциональностью, но и мобильностью;
            </li>
            <li>
              <span class="underline">шкафы,</span>
              <span class="underline">стеллажи для документации,</span>
              позволяющие сортировать и хранить договора, бланки, акты и т.д.;
            </li>
            <li><span class="underline">шкафы для одежды;</span></li>
            <li>кренедении;</li>
            <li>
              вспомогательные элементы. Сюда входят
              <span class="underline">кресла,</span>
              <span class="underline">стулья,</span> кофейные столики,
              аксессуары.
            </li>
          </ul>

          <p class="mb-4">
            Мы поможем купить кабинет готовой комплектации или составить
            подборку по модулям, удовлетворяющую изысканным пожеланиям
            покупателей.
          </p>
        </div>

        <!-- Правая колонка -->
        <div class="w-full md:w-1/2 text-sm sm:text-[16px]">
          <h2 class="text-2xl font-bold mb-2">
            Комплекты мебели для кабинета руководителя покупать выгодно с
            компанией ООО Дары мебели
          </h2>
          <p class="mb-4">
            Наш интернет-магазин создан так, чтобы обеспечивать максимальное
            удобство выбора. Интуитивно понятный интерфейс, разработка
            продуманной навигации позволяет производить отбор по нескольким
            ключевым параметрам. Реалистичные фотографии готовых комплектов дают
            возможность оценить реальные габариты, сориентироваться в их
            стилевых направлениях еще на стадии просмотра каталога. Купить набор
            офисной мебели для руководителя сегодня - это просто, недорого, а
            главное удобно. Сделав заказ прямо сейчас, уже в ближайшее время вы
            сможете комфортно осуществлять руководство бизнесом, проводить
            встречи с партнерами или принимать иностранные делегации.
          </p>
        </div>
      </div>
    </section>
  </div>
</div>
