<!-- Карточка товара -->
<div
    class="js-element simple propvision1 bg-white rounded-lg shadow p-4 lg:p-6 flex flex-col shadow hover:shadow-lg transition-shadow duration-300">
    <div class="relative">
        <?php if (!empty($s['marker'])) { ?>
        <div>
            <span
                class="absolute top-[-14px] left-[-14px] lg:top-[-20px] lg:left-[-20px] bg-[#f0f0f0] rounded-md text-xs lg:text-sm font-semibold text-white px-2 lg:px-4 py-1"
                style="color: <?php echo htmlspecialchars($s['marker']['color']); ?>;
                       /*<?php if (!empty($s['marker']['shadow'])) echo 'text-shadow: 0 1px 1px rgba(0,0,0, 0.7);' ?>*/
                       white-space: normal;">

                <?php
              $text = $s['marker']['text'];
              // Заменяем <br>, <br/>, <br/> и т.п. на пробел
              $text = preg_replace('/<br\s*\/?>/', ' ', $text);
                // Удаляем все остальные теги
                $text = strip_tags($text);
                // Не трогаем пробелы — оставляем как есть
                echo $text;
                ?>

            </span>
        </div>
        <?php } ?>

        <a href="<?php echo Catalog_Series::a($s); ?>">
            <img src="<?php echo Catalog::photoUrl(
                Catalog_Series_Photos::$imagePath,
                $s['1st_photo']['id'], 170, 170, $s['1st_photo']['rm'], $s['1st_photo']['_img_ext']
            ); ?>" alt="<?php echo hsch(
                mb_strtolower(Catalog_Categories::name1($s['category_id'])) . ' ' . mb_strtolower($s['name'])
            ); ?>" title="<?php echo hsch(
                mb_strtolower(Catalog_Categories::name1($s['category_id'])) . ' ' . mb_strtolower($s['name'])
            ); ?>" class="w-full h-28 lg:h-48 object-contain rounded-md mb-4" />
        </a>
    </div>

  <div class="relative mb-1" style="height: 2.5em;">
    <h3 class="font-medium text-sm sm2:text-base lg:text-lg leading-5
            line-clamp-2
            transition-all duration-200
            absolute top-0 left-0 right-0
            hover:line-clamp-none
            hover:z-10
            hover:bg-white
            hover:shadow-lg
            hover:rounded
            hover:px-2
            hover:py-1">
      <a href="<?php echo Catalog_Series::a($s); ?>" class="text-inherit hover:text-inherit block">
        <?php echo htmlspecialchars($s['name']); ?>
      </a>
    </h3>
  </div>

    <div class="flex gap-[6px] justify-start items-center mt-6 mb-3">
        <?php
        $materials = [];
        foreach ($s['materials'] as $m) {
            $materials[] = [
                'name' => $m['name'],
        'img' => Config::pathRel('images') . Catalog_Materials::$imagePath . $m['id'] . '_20x20_0.' . $m['_img_ext']
        ];
        }
        ?>

        <!-- Отображаем первые 7 цветов как квадратики -->
        <?php $count = 0; ?>
        <?php foreach ($materials as $m): ?>
        <?php if ($count >= 7) break; // Ограничиваем 7 цветами ?>
        <span class="w-[14px] h-[14px] sm2:w-[18px] sm2:h-[18px] lg:w-[22px] lg:h-[22px] rounded inline-block"
            style="background-image: url('<?php echo htmlspecialchars($m['img']); ?>'); background-size: cover;"
            title="<?php echo htmlspecialchars($m['name']); ?>">
        </span>
        <?php $count++; ?>
        <?php endforeach; ?>

        <!-- Если больше 7 — показываем "ещё" через hover -->
        <?php if (count($materials) > 7): ?>
        <div class="relative group">
            <svg width="16" height="9" viewBox="0 0 16 9" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M7.29289 8.70721C7.68342 9.09773 8.31658 9.09773 8.70711 8.70721L15.0711 2.34325C15.4616 1.95272 15.4616 1.31956 15.0711 0.929032C14.6805 0.538508 14.0474 0.538508 13.6569 0.929032L8 6.58589L2.34315 0.929032C1.95262 0.538508 1.31946 0.538508 0.928932 0.929032C0.538408 1.31956 0.538408 1.95272 0.928932 2.34325L7.29289 8.70721ZM8 8H7V8.0001H8H9V8H8Z"
                    fill="#020202" />
            </svg>

            <!-- Всплывающее окно с оставшимися цветами -->
            <div
                class="absolute left-0 top-full mt-2 hidden group-hover:block z-10 bg-white border rounded-lg shadow-md w-40 p-2">
                <?php for ($i = 7; $i < count($materials); $i++): ?>
                <span
                    class="w-[14px] h-[14px] sm2:w-[18px] sm2:h-[18px] lg:w-[22px] lg:h-[22px] rounded inline-block mr-1"
                    style="background-image: url('<?php echo htmlspecialchars($materials[$i]['img']); ?>'); background-size: cover;"
                    title="<?php echo htmlspecialchars($materials[$i]['name']); ?>">
                </span>
                <?php endfor; ?>
            </div>
        </div>
        <?php endif; ?>
    </div>

    <!-- Цена -->
    <div class="flex justify-between items-center mb-1">
        <div>
            <div class="font-bold text-lg leading-2 mt-[-6px]">
                <?php if (abs($s['price_search_min']) || abs($s['price_search_max'])): ?>
                <?php echo ($s['price_search_title'] ? $s['price_search_title'] : 'от') ?>
                <?php echo Catalog::priceFormat(floor($s['price_search_min'])) ?> ₽
                <?php elseif (abs($s['price_min'])): ?>
                от
                <?php echo Catalog::priceFormat(floor($s['price_min'])) ?> ₽
                <?php endif; ?>
            </div>
        </div>

        <!-- Сравнение -->
        <div class="flex justify-between gap-4 items-center mt-auto text-gray-500 text-sm mb-3">
            <?php $rnd = rand(1, 1000); ?>
            <div id="series-compare-<?php echo $s['id'] ?>-<?php echo $rnd ?>-0" <?php if
                (Catalog_Compare::check($s['id'])): ?>style="display: none"
                <?php endif; ?>>
                <a href="javascript:void(0)"
                    onclick="oCompare.add(<?php echo $s['id'] ?>, <?php echo $rnd ?>); return false;"
                    class="add2compare1">
                    <img src="/images/index/izbr_small.png" alt="В избранное" />
                </a>
            </div>
            <div id="series-compare-<?php echo $s['id'] ?>-<?php echo $rnd ?>-1" <?php if
                (!Catalog_Compare::check($s['id'])): ?>style="display: none"
                <?php endif; ?>>
                <a href="<?php echo Url::a('catalog-compare') ?>" class="add2compare1 in">
                    <img src="/images/index/srav_small.png" alt="Сравнить" />
                    (<span class="series-compare-cnt">
                        <?php echo Catalog_Compare::count() ?>
                    </span>)
                </a>
                <a href="javascript:void(0)"
                    onclick="oCompare.remove(<?php echo $s['id'] ?>, <?php echo $rnd ?>); return false;" class="dashed">
                    <img style="width:13px;position: relative;top: 2px;" src="/Skins/img/user/close.png"
                        alt="Удалить" />
                </a>
            </div>
        </div>
    </div>

    <!-- Кнопка "Подробнее" -->
    <a href="<?php echo Catalog_Series::a($s); ?>"
        class="mt-auto text-center border-[3px] border-blue-600 text-blue-600 rounded-md px-4 py-2 hover:bg-blue-50 transition">
        Подробнее
    </a>
</div>
