<?php echo CssCopmress::load('cart')?>

<!-- Хлебные крошки -->
<nav class="text-sm text-gray-500 flex flex-wrap items-center gap-1 mb-6">
  <?php if(count($breadcrumbs)) { ?>
  <?php $bcLast = array_pop($breadcrumbs); ?>
  <?php $position = 0; ?>
  <?php foreach($breadcrumbs as $bc) { ?>
  <?php $position = $position + 1; ?>
  <a href="<?php echo $bc['url']; ?>" class="hover:text-gray-700">
    <?php echo $bc['name']; ?>
  </a>
  <span class="mx-1">›</span>
  <?php } ?>
  <span class="text-gray-700">
                    <?php echo $bcLast['name']; ?>
                </span>
  <?php } ?>
</nav>

<div id="content" class="content">
  <div class="">
    <div class="clearfix">
      <?php if(trim($pageInf['text']) !== '') { ?>
      <?php echo ($pageInf['seo_hide'] ? Url_SeoHide::parse($pageInf['text']) : $pageInf['text'])?>
      <div class="cl"></div>
      <?php } ?>

      <?php if($order) { ?>
      <?php
				$cart = $order['cart'];
				$options = $order['options'];
				$user = $order['user'];
				?>
      <div class="order_form_div someform orderforma order-checkout">
        <div class="clearfix flex flex-col lg:flex-row gap-6">
          <script>
            function fixTblSize() {
              var elLeft = $$$('order-view-left');
              var elRight = $$$('order-view-right');
              var elFixLeft = $$$('fix-size-left');
              var elFixRight = $$$('fix-size-right');

              elFixLeft.style.paddingBottom = '10px';
              elFixRight.style.paddingBottom = '10px';

              if (winSize().w < 885) return;

              var hLeft = elSize(elLeft).h;
              var hRight = elSize(elRight).h;
              if (hLeft > hRight) {
                elFixRight.style.paddingBottom = (10 + hLeft - hRight) + 'px';
              } else if (hRight > hLeft) {
                elFixLeft.style.paddingBottom = (10 + hRight - hLeft) + 'px';
              }
            }
            onLoad(function () { fixTblSize() });
            addHandler(
              window,
              'resize',
              function () { fixTblSize() }
            );
          </script>

          <div class="order-view-left flex-1 !w-full" id="order-view-left">
            <h4 class="text-2xl font-semibold mb-4">Данные покупателя</h4>
            <div class="body clearfix" id="fix-size-left">
              <div style="margin-bottom: 5px;">
                Ф.И.О.:
                <strong>
                  <?php echo $user['fio']; ?>
                </strong>
              </div>
              <div style="margin-bottom: 5px;">
                Контактный телефон:
                <strong>
                  <?php echo $user['phone']; ?>
                </strong>
              </div>
              <?php if($order['paymethod'] !== Orders::PAYMETHOD_NO) { ?>
              <div style="margin-bottom: 5px;">
                E-mail:
                <strong>
                  <?php echo $user['email']; ?>
                </strong>
              </div>
              <div style="margin-bottom: 5px;">
                Город:
                <strong>
                  <?php echo $user['city']; ?>
                </strong>
              </div>
              <div style="margin-bottom: 5px;">
                Адрес доставки:
                <strong>
                  <?php echo $user['address']; ?>
                </strong>
              </div>
              <div style="margin-bottom: 5px;">
                Примечание:
                <strong>
                  <?php echo nl2br($user['info'])?>
                </strong>
              </div>
              <?php } ?>
            </div>

            <h4 class="text-2xl font-semibold mb-4">Заказ</h4>
            <div class="body clearfix">
              <div style="margin-bottom: 5px;">
                ID заказа:
                <strong>
                  <?php echo $order['id']; ?>
                </strong>
              </div>
              <div style="margin-bottom: 5px;">
                Оформлен:
                <strong>
                  <?php echo date('d.m.Y в H:i', MySQL::fromDateTime($order['date']))?>
                </strong>
              </div>
              <div style="margin-bottom: 5px;">
                Статус:
                <strong style="color: <?php echo $order['status_color']; ?>">
                  <?php echo $order['status_name']; ?>
                </strong>
                <?php if($order['date'] != $order['status_date']) { ?>
                <span style="font-size: 12px;">(обновлён
                  <?php echo date('d.m.Y в H:i', MySQL::fromDateTime($order['status_date']))?>)
								</span>
                <?php } ?>
              </div>
            </div>

          </div>

          <div class="order-view-right flex-1 !w-full" id="order-view-right">
            <h4 class="text-2xl font-semibold mb-4">Опции заказа</h4>
            <div class="body clearfix">
              <div style="margin-bottom: 5px;">
                Способ оплаты:
                <strong>
                  <?php echo Orders::$paymethods[$order['paymethod']]; ?>
                </strong>
              </div>
              <?php if($order['paymethod'] !== Orders::PAYMETHOD_NO) { ?>
              <div style="margin-bottom: 5px;">
                Доставка:
                <strong>
                  <?php echo $options[Orders_Options::DELIVERY]['info']; ?>
                  (
                  <?php echo Catalog::priceFormat($options[Orders_Options::DELIVERY]['price'])?> руб.)
                </strong>
              </div>
              <div style="margin-bottom: 5px;">
                Разгрузка:
                <strong>
                  <?php echo $options[Orders_Options::UNLOADING]['info']; ?>
                  (
                  <?php echo Catalog::priceFormat($options[Orders_Options::UNLOADING]['price'])?>
                  руб.)
                </strong>
              </div>
              <div style="margin-bottom: 5px;">
                Сборка:
                <strong>
                  <?php echo $options[Orders_Options::ASSEMBLY]['info']; ?>
                  (
                  <?php echo Catalog::priceFormat($options[Orders_Options::ASSEMBLY]['price'])?> руб.)
                </strong>
              </div>
              <div style="margin-bottom: 5px;">
                Вывоз мусора:
                <strong>
                  <?php
                    $info = $options[Orders_Options::GARBAGE]['info'] ?? '';
                    if (stripos($info, 'не нужен') !== false) {
                      echo '0 руб.';
                    } else {
                      echo 'Уточнить у менеджера';
                    }
                    ?>
                </strong>
              </div>
              <?php } ?>
            </div>

            <h4 class="text-2xl font-semibold mb-4">Итоговая стоимость</h4>
            <div class="body clearfix" id="fix-size-right">
              <div class="order-total clearfix space-y-4">
                <?php if($order['paymethod'] !== Orders::PAYMETHOD_NO) { ?>

                <div class="clearfix">
                  <div class="price">
                    Итого:
                    <strong class="ml-1">
                      <?php echo Catalog::priceFormat($order['price_out'] + $order['price_options'])?>
                      руб.
                    </strong>
                  </div>
                </div>
                <?php } else { ?>
                <div class="clearfix">
                  <div class="price">
                    Итого:
                    <strong class="ml-1">
                      <?php echo Catalog::priceFormat($order['price_out'])?>
                      руб.
                    </strong>
                  </div>
                </div>
                <?php } ?>
              </div>
            </div>
          </div>
        </div>

        <div class="section summary">
          <h4 class="text-2xl font-semibold mb-4">Товары в заказе</h4>
          <div class="body">
            <table class="products js-element w-full text-sm">
              <tr>
                <th class="item nowrap text-left px-2 py-2 bg-gray-50">Серия</th>
                <th class="custom nowrap text-left px-2 py-2 bg-gray-50">Товар</th>
                <th class="custom nowrap text-left px-2 py-2 bg-gray-50">Цвет</th>
                <th class="custom nowrap text-left px-2 py-2 bg-gray-50">Кол-во</th>
                <th class="custom nowrap text-left px-2 py-2 bg-gray-50">Цена</th>
                <th class="custom nowrap text-left px-2 py-2 bg-gray-50">Сумма</th>
              </tr>
              <?php foreach($cart as $c) { ?>
              <tr>
                <td class="item px-2 py-2">
                  <?php if($c['series']) { ?>
                  <a class="text-blue-600 hover:text-blue-800"
                     href="<?php echo Catalog_Series::a($c['series'])?>">
                    <?php echo $c['series']['name']; ?>
                  </a>
                  <?php } ?>
                </td>
                <td class="itemname px-2 py-2">
                  <div class="pic">
                    <?php if($c['item']['_img_ext']) { ?>
                    <img src="<?php echo Catalog::photoUrl(
																Catalog_Items::$imagePath,
																$c['item']['id'], 30, 30, 1, $c['item']['_img_ext'],
																$c['item']['image-name']
															)?>" class="rounded">
                    <?php } ?>
                  </div>
                  <div class="text">
                    <?php echo $c['item']['name']; ?><br>
                    <span>
											Арт.:
                      <?php echo $c['item']['art']; ?><br>
                      <?php if(trim($c['item']['size']) !== '') { ?>
                      Размер:
                      <?php echo $c['item']['size']; ?>
                      <?php } ?>
										</span>
                  </div>
                </td>
                <td class="material px-4 py-3 text-center" style="min-width: 100px;">
                  <?php if ($c['material']): ?>
                  <div class="flex flex-col items-center justify-center gap-2">
                    <?php if ($c['material']['_img_ext']): ?>
                    <a
                      href="javascript:void(0)"
                      onclick="openMaterialModal('<?php echo Config::pathRel('images') . Catalog_Materials::$imagePath . $c['material']['id']; ?>.<?php echo $c['material']['_img_ext']; ?>', '<?php echo hsch(implode(' / ', Catalog_Materials::getFullName($c['material']['id']))); ?>')"
                      class="block"
                    >
                      <img
                        src="<?php echo Config::pathRel('images') . Catalog_Materials::$imagePath . $c['material']['id']; ?>_24x24_0.<?php echo $c['material']['_img_ext']; ?>"
                        width="24"
                        height="24"
                        alt="<?php echo hsch(implode(' / ', Catalog_Materials::getFullName($c['material']['id']))); ?>"
                        class="rounded border"
                      />
                    </a>

                    <!-- Скрытый элемент для модального окна -->
                    <div class="material-modal hidden">
                      <div class="modal-overlay"></div>
                      <div class="modal-content">
                        <div class="flex justify-end">
                          <button class="modal-close bg-red-600 hover:bg-red-700" onclick="closeMaterialModal()">&times;</button>
                        </div>
                        <div class="modal-header">
                          <h3 class="modal-title "></h3>
                        </div>
                        <div class="modal-body flex justify-center">
                          <img src="" alt="" class="modal-image" />
                        </div>
                      </div>
                    </div>
                    <?php endif; ?>
                    <div class="whitespace-normal text-xs text-gray-700">
                      <?php echo implode('<br>', Catalog_Materials::getFullName($c['material']['id'])); ?>
                    </div>
                  </div>
                  <?php else: ?>
                  &nbsp;
                  <?php endif; ?>
                </td>

                <td class="nowrap right px-2 py-2">
                  <?php echo $c['amount']; ?>
                  шт
                </td>
                <td class="nowrap right px-2 py-2">
                  <?php if(abs($c['price'])) { ?>
                  <?php echo Catalog::priceFormat($c['price'])?>
                  руб.
                  <?php if(abs($c['item']['discount']) != 1) { ?>
                  <?php $d = Catalog::num2percent($c['item']['discount'], Catalog::PC_DECREASE); ?>
                  <br>
                  <span class="discount" title="Цена со скидкой <?php echo $d?>%">
										(-
                    <?php echo $d?>%)
									</span>
                  <?php } ?>
                  <?php } else { ?>
                  по запросу
                  <?php } ?>
                </td>
                <td class="nowrap right px-2 py-2">
                  <?php echo Catalog::priceFormat($c['price'] * $c['amount'])?>
                  руб.
                </td>
              </tr>
              <?php } ?>
            </table>

            <script>
              function openMaterialModal(imageSrc, title) {
                const modal = document.querySelector('.material-modal');
                const modalImage = modal.querySelector('.modal-image');
                const modalTitle = modal.querySelector('.modal-title');

                modalImage.src = imageSrc;
                modalImage.alt = title;
                modalTitle.textContent = title;

                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Запрещаем скролл страницы
              }

              function closeMaterialModal() {
                const modal = document.querySelector('.material-modal');
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Восстанавливаем скролл
              }

              // Закрытие по клику на оверлей
              document.addEventListener('DOMContentLoaded', function() {
                const modal = document.querySelector('.material-modal');
                modal.querySelector('.modal-overlay').addEventListener('click', closeMaterialModal);

                // Закрытие по ESC
                document.addEventListener('keydown', function(e) {
                  if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    closeMaterialModal();
                  }
                });
              });
            </script>

            <style>
              .material-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1000;
              }

              .material-modal.hidden {
                display: none;
              }

              .modal-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(3px);
              }

              .modal-content {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 12px;
                max-width: 90%;
                max-height: 90%;
                width: auto;
                overflow: hidden;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
              }

              .modal-header {
                padding: 16px 24px;
                border-bottom: 1px solid #e5e7eb;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: #f9fafb;
              }

              .modal-title {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
                color: #111827;
                white-space: normal;
              }

              .modal-close {
                background-color: #ff0000ab;
                border: none;
                font-size: 32px;
                cursor: pointer;
                color: white;
                line-height: 1;
                padding: 2px;
                margin: 4px;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background-color 0.2s;
              }

              .modal-close:hover {
                background-color: #ff0000f1;
              }

              .modal-body {
                padding: 24px;
                text-align: center;
                max-height: calc(90vh - 73px);
                overflow: auto;
              }

              .modal-image {
                max-width: 100%;
                max-height: 70vh;
                height: auto;
                width: auto;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
              }
            </style>

            <div class="order_pay">
              <div class="right">
                <table class="bx_ordercart_order_sum">
                  <tr>
                    <td class="custom_t1 fwb" colspan="6" class="itog">
                      Итого:&nbsp;
                    </td>
                    <td class="custom_t2 fwb price">
                      <?php echo Catalog::priceFormat($order['price_out'])?>
                      руб.
                    </td>
                  </tr>
                  <tr>
                    <td class="custom_t1" colspan="6"></td>
                    <td class="custom_t2">
                      <?php echo $order['amount']; ?> шт.
                    </td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <?php } else { ?>
      <?php echo Pages::msgErr('Неверный URL для мониторинга заказа.')?>
      <?php } ?>
    </div>
  </div>
</div>
